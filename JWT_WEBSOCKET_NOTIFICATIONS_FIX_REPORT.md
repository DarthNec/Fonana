# –û—Ç—á–µ—Ç –æ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–º —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º —Å JWT, WebSocket –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏

## –î–∞—Ç–∞: 30 –∏—é–Ω—è 2025

### –ò—Å—Ö–æ–¥–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞
- JWT —Ç–æ–∫–µ–Ω—ã –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–æ—à–∏–±–∫–∞ 400)
- WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –æ—Ç–≤–µ—Ä–≥–∞–ª–∏—Å—å —Å –æ—à–∏–±–∫–æ–π "invalid signature"
- API —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤–æ–∑–≤—Ä–∞—â–∞–ª 401 Unauthorized
- –ö–ª–∏–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Ç–æ–∫–µ–Ω—ã –¥–ª–∏–Ω–æ–π 297 —Å–∏–º–≤–æ–ª–æ–≤

### –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

#### 1. –ü–µ—Ä–µ–ø—É—Ç–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã API –º–∞—Ä—à—Ä—É—Ç–æ–≤
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ —Ñ–∞–π–ª `/var/www/fonana/app/api/auth/wallet/route.ts` —Å–æ–¥–µ—Ä–∂–∞–ª –∫–æ–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤–º–µ—Å—Ç–æ –∫–æ–¥–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- **–ü—Ä–∏—á–∏–Ω–∞**: –í–µ—Ä–æ—è—Ç–Ω–æ, –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ –∏–ª–∏ –¥–µ–ø–ª–æ–µ
- **–†–µ—à–µ–Ω–∏–µ**: –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–∞–π–ª —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã

#### 2. –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤ Next.js
- **–ü—Ä–æ–±–ª–µ–º–∞**: –ü–æ—Å–ª–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ API –≤—Å–µ –µ—â–µ –≤–æ–∑–≤—Ä–∞—â–∞–ª —Å—Ç–∞—Ä—É—é –æ—à–∏–±–∫—É
- **–ü—Ä–∏—á–∏–Ω–∞**: Next.js –∫–µ—à–∏—Ä–æ–≤–∞–ª —Å—Ç–∞—Ä—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã
- **–†–µ—à–µ–Ω–∏–µ**: –í—ã–ø–æ–ª–Ω–µ–Ω–∞ –ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (`npm run build`)

#### 3. –†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è JWT —Å–µ–∫—Ä–µ—Ç–æ–≤
- **–ü—Ä–æ–±–ª–µ–º–∞**: WebSocket —Å–µ—Ä–≤–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –¥—Ä—É–≥–æ–π —Å–µ–∫—Ä–µ—Ç –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**: –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `debug-jwt-sync.js` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –°–µ–∫—Ä–µ—Ç—ã –±—ã–ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

#### 1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ API endpoint
```bash
# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
scp -P 43988 app/api/auth/wallet/route.ts root@69.10.59.234:/var/www/fonana/app/api/auth/wallet/route.ts

# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
ssh -p 43988 root@69.10.59.234 "cd /var/www/fonana && npm run build"

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
ssh -p 43988 root@69.10.59.234 "pm2 restart fonana"
```

#### 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ WebSocket —Å–µ—Ä–≤–µ—Ä–∞
```bash
ssh -p 43988 root@69.10.59.234 "pm2 restart fonana-ws"
```

#### 3. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
- `scripts/debug-jwt-sync.js` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ JWT —Ç–æ–∫–µ–Ω–æ–≤
- `scripts/test-ws-jwt.js` - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

#### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —á–∞—Å—Ç–∏
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ç–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–∞ —á–µ—Ä–µ–∑ API
- –î–æ–±–∞–≤–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket –ø–æ—Å–ª–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

#### 1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JWT —Ç–æ–∫–µ–Ω–∞ ‚úÖ
```bash
curl -X POST https://fonana.me/api/auth/wallet \
  -H 'Content-Type: application/json' \
  -d '{"wallet":"npzAZaN9fDMgLV63b3kv3FF8cLSd8dQSLxyMXASA5T4"}'

# –†–µ–∑—É–ª—å—Ç–∞—Ç: –¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω (296 —Å–∏–º–≤–æ–ª–æ–≤)
```

#### 2. WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ ‚úÖ
```bash
# –¢–µ—Å—Ç —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º
‚úÖ WebSocket connected successfully!
üìÆ Sent subscription request
üì® Received: {"type":"connected","data":{"userId":"cmbv53b7h0000qoe0vy4qwkap"}}
```

#### 3. API —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π ‚úÖ
```bash
curl -X GET https://fonana.me/api/user/notifications \
  -H "Authorization: Bearer [TOKEN]"

# –†–µ–∑—É–ª—å—Ç–∞—Ç: –£—Å–ø–µ—à–Ω–æ –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
```

### –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

#### 1. JWT Manager (`lib/utils/jwt.ts`)
- –£–∂–µ –±—ã–ª –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π endpoint `/api/auth/wallet`

#### 2. WebSocket Service (`lib/services/websocket.ts`)
- –£–∂–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å JWT Manager
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏

#### 3. –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (`public/test-websocket-notifications.html`)
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
- –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
- –ê–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket –ø–æ—Å–ª–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- **Auth Failures –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: 2241+ –ø–æ–ø—ã—Ç–æ–∫ —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏
- **–£—Å–ø–µ—à–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: 100%
- **–î–ª–∏–Ω–∞ —Å—Ç–∞—Ä—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤**: 297 —Å–∏–º–≤–æ–ª–æ–≤ (–Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ)
- **–î–ª–∏–Ω–∞ –Ω–æ–≤—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤**: 296 —Å–∏–º–≤–æ–ª–æ–≤ (–≤–∞–ª–∏–¥–Ω—ã–µ)

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
1. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö endpoints –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è
3. –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
4. –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—É—é —Å–∏—Å—Ç–µ–º—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –ó–∞–∫–ª—é—á–µ–Ω–∏–µ
–í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã —É—Å–ø–µ—à–Ω–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã. –°–∏—Å—Ç–µ–º–∞ JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏ API —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–∏—á–∏–Ω–æ–π –ø—Ä–æ–±–ª–µ–º—ã –±—ã–ª–æ –ø–µ—Ä–µ–ø—É—Ç—ã–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, —á—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –∏ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. 