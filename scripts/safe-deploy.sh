#!/bin/bash

# ðŸš€ Ð‘Ð•Ð—ÐžÐŸÐÐ¡ÐÐ«Ð™ Ð¡ÐšÐ Ð˜ÐŸÐ¢ Ð”Ð•ÐŸÐ›ÐžÐ¯ FONANA
# Ð’ÐµÑ€ÑÐ¸Ñ: 3.0
# Ð”Ð°Ñ‚Ð°: 2024-12-17
# 
# Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¾Ð±ÐµÑÐ¿ÐµÑ‡Ð¸Ð²Ð°ÐµÑ‚ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹ Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¼ Ð¾Ñ‚ÐºÐ°Ñ‚Ð¾Ð¼
# Ð¿Ñ€Ð¸ Ð»ÑŽÐ±Ñ‹Ñ… Ð¾ÑˆÐ¸Ð±ÐºÐ°Ñ…. Ð’ÑÐµÐ³Ð´Ð° ÑÐ¾Ð·Ð´Ð°ÐµÑ‚ Ð±ÑÐºÐ°Ð¿ Ð¿ÐµÑ€ÐµÐ´ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸ÑÐ¼Ð¸.

set -e

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð²Ñ‹Ð²Ð¾Ð´Ð°
success() { echo -e "${GREEN}âœ… $1${NC}"; }
error() { echo -e "${RED}âŒ $1${NC}"; exit 1; }
warning() { echo -e "${YELLOW}âš ï¸  $1${NC}"; }
info() { echo -e "â„¹ï¸  $1"; }

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ
restore_backup() {
    warning "Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¸Ð· Ð±ÑÐºÐ°Ð¿Ð°..."
    cp -r "/backup/fonana-backup-$(date +%Y%m%d)" "/var/www/Fonana" || error "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð±ÑÐºÐ°Ð¿"
    pm2 restart fonana
    error "Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½, ÑÐ¸ÑÑ‚ÐµÐ¼Ð° Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°"
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°, Ñ‡Ñ‚Ð¾ Ð¼Ñ‹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
if [ ! -d "/var/www/Fonana" ]; then
    error "Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒÑÑ Ð½Ð° Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐ½ ÑÐµÑ€Ð²ÐµÑ€Ðµ!"
fi

# ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
cd /var/www/Fonana || error "ÐÐµ Ð¼Ð¾Ð³Ñƒ Ð¿ÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°"

# Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚ Ð´Ð»Ñ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ÐºÐ°Ñ‚Ð°
CURRENT_COMMIT=$(git rev-parse HEAD)
info "Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚: $CURRENT_COMMIT"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð±ÑÐºÐ°Ð¿
BACKUP_DIR="/backup/fonana-backup-$(date +%Y%m%d-%H%M%S)"
info "Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð±ÑÐºÐ°Ð¿ Ð² $BACKUP_DIR..."
mkdir -p /backup
cp -r "/var/www/Fonana" "$BACKUP_DIR" || error "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð±ÑÐºÐ°Ð¿"
success "Ð‘ÑÐºÐ°Ð¿ ÑÐ¾Ð·Ð´Ð°Ð½"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ Git
info "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Git ÑÑ‚Ð°Ñ‚ÑƒÑ..."
if [[ -n $(git status --porcelain) ]]; then
    warning "ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ñ‹ Ð½ÐµÐ·Ð°ÐºÐ¾Ð¼Ð¼Ð¸Ñ‡ÐµÐ½Ð½Ñ‹Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ!"
    git status
    echo ""
    read -p "ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        error "Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼"
    fi
fi

# ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð´
info "ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð´ Ð¸Ð· Git..."
git fetch origin || error "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¸Ð· Git"
git pull origin main || {
    restore_backup
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
NEW_COMMIT=$(git rev-parse HEAD)
if [[ "$CURRENT_COMMIT" == "$NEW_COMMIT" ]]; then
    info "ÐÐ¾Ð²Ñ‹Ñ… Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð½ÐµÑ‚"
    exit 0
fi

success "ÐšÐ¾Ð´ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½ Ð´Ð¾ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°: $NEW_COMMIT"

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
info "ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸..."
npm ci || {
    restore_backup
}

# ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð‘Ð” (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)
if [ -f "prisma/schema.prisma" ]; then
    info "ÐŸÑ€Ð¸Ð¼ÐµÐ½ÑÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð‘Ð”..."
    read -p "ÐŸÑ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Prisma? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        npx prisma migrate deploy || {
            restore_backup
        }
        success "ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ñ‹"
    fi
fi

# Ð‘Ð¸Ð»Ð´Ð¸Ð¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
info "ðŸ—ï¸  Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ..."
NODE_ENV=production npm run build || {
    restore_backup
}

success "ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ ÑÐ¾Ð±Ñ€Ð°Ð½Ð¾"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ .next Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð°
if [ ! -d ".next" ]; then
    restore_backup
fi

# ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
info "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ..."
pm2 reload fonana --update-env || {
    warning "PM2 reload Ð½Ðµ ÑƒÐ´Ð°Ð»ÑÑ, Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ restart..."
    pm2 restart fonana || {
        restore_backup
    }
}

# Ð–Ð´ÐµÐ¼ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾ Ð´Ð»Ñ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸
sleep 5

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
info "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
if pm2 list | grep -q "fonana.*online"; then
    success "ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"
else
    restore_backup
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ HTTP-Ð¾Ñ‚Ð²ÐµÑ‚
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 || echo "000")
if [[ "$HTTP_CODE" == "200" ]]; then
    success "HTTP Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ð°"
else
    warning "HTTP Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ðµ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ð° (ÐºÐ¾Ð´: $HTTP_CODE)"
    restore_backup
fi

# ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð±ÑÐºÐ°Ð¿Ñ‹ (Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 5)
info "ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð±ÑÐºÐ°Ð¿Ñ‹..."
ls -t /backup/fonana-backup-* | tail -n +6 | xargs -r rm -rf

# ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐµÑˆ Next.js (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
if [ -d ".next/cache" ]; then
    info "ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÐºÐµÑˆ Next.js..."
    rm -rf .next/cache
fi

success "ðŸŽ‰ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"
success "ðŸ”— ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ Ð½Ð° https://fonana.me"

# ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
info "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ PM2:"
pm2 status

# ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð»Ð¾Ð³Ð¸
info "ðŸ“‹ ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð»Ð¾Ð³Ð¸ (10 ÑÑ‚Ñ€Ð¾Ðº):"
pm2 logs fonana --lines 10 --nostream

# ÐŸÐ¾Ð´ÑÐºÐ°Ð·ÐºÐ¸ Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°
echo ""
info "ðŸ’¡ ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
echo "   â€¢ Ð›Ð¾Ð³Ð¸: pm2 logs fonana"
echo "   â€¢ Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: pm2 status"
echo "   â€¢ Ð ÐµÑÑ‚Ð°Ñ€Ñ‚: pm2 restart fonana"
echo "   â€¢ ÐžÑ‚ÐºÐ°Ñ‚: git reset --hard $CURRENT_COMMIT && npm run build && pm2 restart fonana"
echo ""

# Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ðµ
echo "$(date): Deploy completed. Commit: $NEW_COMMIT" >> /var/log/fonana-deploys.log

success "Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½! ðŸš€" 