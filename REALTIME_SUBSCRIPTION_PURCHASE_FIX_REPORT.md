# –û—Ç—á–µ—Ç: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–æ–≤ –ø–æ–¥–ø–∏—Å–∫–∏, –ø–æ–∫—É–ø–∫–∏ –ø–æ—Å—Ç–æ–≤ –∏ real-time —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

## –î–∞—Ç–∞: 30 –∏—é–Ω—è 2025
## –ê–≤—Ç–æ—Ä: AI Assistant

## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

1. **–ü–ª–∞—Ç–Ω—ã–µ –ø–æ—Å—Ç—ã –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏** - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è "–ö–æ–Ω—Ç–µ–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω", –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —É—Å–ø–µ—à–Ω—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
2. **–û—à–∏–±–∫–∞ "User wallet required" –ø—Ä–∏ –ø–æ–¥–ø–∏—Å–∫–µ** - API –æ–∂–∏–¥–∞–ª –∑–∞–≥–æ–ª–æ–≤–æ–∫ `x-user-wallet` –≤–º–µ—Å—Ç–æ JWT
3. **WalletSendTransactionError –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –ø–ª–∞—Ç–µ–∂–∞** - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
4. **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç real-time —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** - –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏, —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞

## –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. API –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

#### `/api/subscriptions/process-payment/route.ts`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–∞—Ä—è–¥—É —Å –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å—é –¥–ª—è `x-user-wallet`
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ—Ç–¥–∞–µ—Ç—Å—è JWT —Ç–æ–∫–µ–Ω—É –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ Authorization
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–¥–∞—á–∞ –∫–æ—à–µ–ª—å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é

```typescript
// –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
if (authHeader && authHeader.startsWith('Bearer ')) {
  const token = authHeader.split(' ')[1]
  const decoded = jwt.verify(token, ENV.NEXTAUTH_SECRET) as any
  userId = decoded.userId
}
```

### 2. Frontend –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

#### `components/PurchaseModal.tsx`
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω API endpoint —Å `/api/posts/process-payment` –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `/api/posts/[id]/buy`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞
- –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (WalletSendTransactionError)

#### `components/SubscriptionPayment.tsx`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ JWT —Ç–æ–∫–µ–Ω–∞ –Ω–∞—Ä—è–¥—É —Å `x-user-wallet` –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

#### `components/SubscribeModal.tsx`
- –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

### 3. Real-time —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

#### `components/posts/layouts/PostsContainer.tsx`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ `useRealtimePosts`
- –ù–æ–≤—ã–µ props: `enableRealtime`, `showNewPostsNotification`, `autoUpdateFeed`
- –î–æ–±–∞–≤–ª–µ–Ω UI –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–∞—Ö

#### `lib/hooks/useRealtimePosts.tsx`
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `handlePostPurchased` - —Ç–µ–ø–µ—Ä—å —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `shouldHideContent: false`
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `handleSubscriptionUpdated` - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç –≤—Å–µ –ø–æ–ª—è –¥–æ—Å—Ç—É–ø–∞

### 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- –û—Ç–º–µ–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ –æ—à–∏–±–∫–∏
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ `WalletSendTransactionError` 
- –£–ª—É—á—à–µ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–µ–π—á–∞—Å:
1. **–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –ø–ª–∞—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞** - –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ –ø–æ—Å—Ç —Å—Ä–∞–∑—É —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –¥–æ—Å—Ç—É–ø–µ–Ω –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
2. **–ü–æ–¥–ø–∏—Å–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
3. **–û—Ç–º–µ–Ω–∞ –ø–ª–∞—Ç–µ–∂–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
4. **Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** - —Å–æ–±—ã—Ç–∏—è –ø–æ–∫—É–ø–∫–∏ –∏ –ø–æ–¥–ø–∏—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç UI –º–≥–Ω–æ–≤–µ–Ω–Ω–æ

### üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è:
1. –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (JWT –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç, x-user-wallet –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
2. –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI –¥–ª—è –ª—É—á—à–µ–≥–æ UX
3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö edge-cases (–æ—Ç–º–µ–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ —Å—Ä–µ–¥—Å—Ç–≤, –∏—Å—Ç–µ—á–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
4. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–æ–±—ã—Ç–∏–π —á–µ—Ä–µ–∑ window.dispatchEvent –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

### üìã –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
1. WebSocket –∫–ª–∏–µ–Ω—Ç (`lib/services/websocket-client.ts`) —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–≥–ª—É—à–∫–∏ - —Ç—Ä–µ–±—É–µ—Ç—Å—è backend —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
2. Real-time —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∂–¥–µ—Ç WebSocket API
3. –°–æ–±—ã—Ç–∏—è —Å–µ–π—á–∞—Å —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –æ–¥–Ω–æ–π —Å–µ—Å—Å–∏–∏ –±—Ä–∞—É–∑–µ—Ä–∞)

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å WebSocket API –Ω–∞ –±—ç–∫–µ–Ω–¥–µ –¥–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π real-time —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
2. –î–æ–±–∞–≤–∏—Ç—å retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è –Ω–µ—É–¥–∞—á–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—Ñ—Ñ–ª–∞–π–Ω –ø–æ–¥–¥–µ—Ä–∂–∫—É —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
4. –î–æ–±–∞–≤–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

### –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤:
1. –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ JWT –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ –Ω–æ–≤–æ–º –∫–æ–¥–µ
2. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –æ—Ç–º–µ–Ω—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∫–∞–∫ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π, –Ω–µ –æ—à–∏–±–∫—É
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `PostsContainer` —Å `enableRealtime={true}` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ real-time
4. –û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–æ–±—ã—Ç–∏—è —á–µ—Ä–µ–∑ `window.dispatchEvent` –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:
1. **–ü–æ–∫—É–ø–∫–∞ –ø–æ—Å—Ç–∞**: –ø–æ—Å—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–∫—Ä—ã—Ç—å—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–æ—Å–ª–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
2. **–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–∑–¥–∞—Ç–µ–ª—è**: –≤—Å–µ –ø–æ—Å—Ç—ã —Ç–∏—Ä–∞ –¥–æ–ª–∂–Ω—ã —Å—Ç–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã —Å—Ä–∞–∑—É
3. **–û—Ç–º–µ–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**: –¥–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å "–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞" –±–µ–∑ –æ—à–∏–±–æ–∫
4. **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ —Å—Ä–µ–¥—Å—Ç–≤**: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
5. **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏**: –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å –≤–æ –≤—Å–µ—Ö –≤–∫–ª–∞–¥–∫–∞—Ö

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
curl -X POST https://fonana.me/api/subscriptions/process-payment \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"creatorId": "123", "plan": "premium", "price": 0.5, ...}'

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ–±—ã—Ç–∏–π –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞
window.addEventListener('post-purchased', (e) => console.log('Post purchased:', e.detail))
window.addEventListener('subscription-updated', (e) => console.log('Subscription updated:', e.detail))
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã. –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ —Ç–µ–ø–µ—Ä—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –∫–æ–Ω—Ç–µ–Ω—Ç—É –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —É—Å—Ç–æ–π—á–∏–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –∏ –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞.

–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è real-time —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ WebSocket API –Ω–∞ backend. 