# Отчет об устранении проблем авторизации и сетевого взаимодействия на Fonana

## Дата: 30 июня 2025

## Критические обнаруженные проблемы:

### 1. ❌ Несоответствие заголовков авторизации
**Проблема**: Компоненты фронтенда все еще используют старый заголовок `x-user-wallet` вместо JWT токенов.

**Найдено в:**
- `components/SellablePostModal.tsx` - покупка постов
- `components/SubscribeModal.tsx` - подписки
- `app/messages/[id]/page.tsx` - покупка PPV сообщений (уже исправлено)
- `lib/contexts/NotificationContext.tsx` - 5 мест
- `components/SubscriptionPayment.tsx`
- `components/Navbar.tsx`
- `components/BottomNav.tsx`
- `app/creator/[id]/page.tsx`
- `app/admin/referrals/page.tsx` - 3 места

### 2. ❌ Критическая ошибка Nginx конфигурации
**Проблема**: Nginx проксирует все запросы на порт 3001, а приложение работает на порту 3000!

**Доказательства**:
```
proxy_pass http://localhost:3001;  # Во всех location блоках
PM2 status: fonana работает на порту 3000
```

**Последствия**: 
- Все запросы возвращают 502 Bad Gateway
- API не доступны
- Статические ресурсы не загружаются

### 3. ⚠️ WebSocket JWT авторизация
**Проблема**: WebSocket получает "invalid signature" при проверке JWT токенов.

**Вероятная причина**: 
- JWT токены создаются правильно
- WebSocket клиент отправляет токены правильно
- Но Nginx может не проксировать WebSocket на правильный порт

### 4. ✅ Service Worker
**Статус**: Service Worker настроен правильно, версия v5, не вызывает проблем.

## План исправлений:

### Фаза 1: Срочное исправление Nginx (КРИТИЧНО!)
1. Изменить все `proxy_pass http://localhost:3001` на `proxy_pass http://localhost:3000`
2. Проверить server_name и изменить на fonana.me
3. Перезагрузить Nginx

### Фаза 2: Обновление компонентов фронтенда
1. Заменить все использования `x-user-wallet` на JWT авторизацию
2. Добавить импорт `jwtManager` где необходимо
3. Обработать ошибки получения токена

### Фаза 3: Проверка WebSocket
1. После исправления Nginx проверить WebSocket соединения
2. Убедиться что JWT токены валидируются правильно

### Фаза 4: Комплексное тестирование
1. Покупка платного поста
2. Отправка сообщений
3. Покупка PPV сообщений
4. Подписки на создателей
5. WebSocket уведомления

## Прогресс:
- [x] Диагностика проблем
- [x] Исправление `app/messages/[id]/page.tsx`
- [x] Исправление `components/SellablePostModal.tsx`
- [x] Исправление `components/SubscribeModal.tsx`
- [ ] Исправление Nginx конфигурации
- [ ] Исправление остальных компонентов
- [ ] Тестирование

## Следующие шаги:
1. СРОЧНО исправить Nginx конфигурацию
2. Продолжить обновление компонентов для JWT
3. Протестировать все сценарии 