# –û—Ç—á–µ—Ç –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã WebSocket –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**–î–∞—Ç–∞**: 30 –∏—é–Ω—è 2025  
**–í—Ä–µ–º—è**: 02:00 - 02:35 MSK  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ü–†–ê–í–õ–ï–ù–û

## –ò—Å—Ö–æ–¥–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

WebSocket-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª–æ—Å—å, –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –ø–æ–ª—É—á–∞–ª–∞ –æ—à–∏–±–∫—É `NS_ERROR_WEBSOCKET_CONNECTION_REFUSED`. API —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤–æ–∑–≤—Ä–∞—â–∞–ª 401 Unauthorized –¥–∞–∂–µ —Å –≤–∞–ª–∏–¥–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º.

## –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. WebSocket —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–≥—Ä—É–∂–∞–ª –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- **–°–∏–º–ø—Ç–æ–º—ã**: 
  - –û—à–∏–±–∫–∞ Prisma: "the URL must start with the protocol postgresql://"
  - –û—à–∏–±–∫–∞ JWT: "Cannot read properties of undefined (reading 'user')"
- **–ü—Ä–∏—á–∏–Ω–∞**: dotenv –∏—Å–∫–∞–ª .env —Ñ–∞–π–ª –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ websocket-server
- **–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞**: `pm2 env 2 | grep DATABASE_URL` –≤–æ–∑–≤—Ä–∞—â–∞–ª 0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### 2. Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –±—ã–ª–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞
- **–°–∏–º–ø—Ç–æ–º—ã**: 404 Not Found –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ /ws
- **–ü—Ä–∏—á–∏–Ω–∞**: –û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∞—è —Å—Å—ã–ª–∫–∞ –≤ /etc/nginx/sites-enabled/
- **–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞**: `ls /etc/nginx/sites-enabled/fonana` –≤–æ–∑–≤—Ä–∞—â–∞–ª "No such file"

### 3. –ü–æ—Ä—Ç 3002 —Å–ª—É—à–∞–ª—Å—è —Ç–æ–ª—å–∫–æ PM2 God Daemon
- **–°–∏–º–ø—Ç–æ–º—ã**: WebSocket –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –º–æ–≥ —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å
- **–ü—Ä–∏—á–∏–Ω–∞**: –û—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–æ–≤–∞–ª–∏ –∑–∞–ø—É—Å–∫—É

## –ü—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
```javascript
// websocket-server/index.js
require('dotenv').config({ path: require('path').join(__dirname, '..', '.env') });

// –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
console.log('üîç Checking environment variables...');
if (!process.env.DATABASE_URL) {
  console.error('‚ùå DATABASE_URL not found! Check .env file');
  process.exit(1);
}
if (!process.env.NEXTAUTH_SECRET) {
  console.error('‚ùå NEXTAUTH_SECRET not found! Check .env file');
  process.exit(1);
}
console.log('‚úÖ Environment variables loaded');
```

### 2. –ê–∫—Ç–∏–≤–∞—Ü–∏—è Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```bash
# –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–æ–π —Å—Å—ã–ª–∫–∏
ln -s /etc/nginx/sites-available/fonana /etc/nginx/sites-enabled/fonana

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Nginx
systemctl reload nginx
```

### 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ WebSocket —Å–µ—Ä–≤–µ—Ä–∞
```bash
# –£–¥–∞–ª–µ–Ω–∏–µ —Å–±–æ–π–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
pm2 delete fonana-ws

# –ó–∞–ø—É—Å–∫ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
pm2 start ecosystem.config.js --only fonana-ws
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### WebSocket —Å–µ—Ä–≤–µ—Ä
```
‚úÖ Environment variables loaded
‚úÖ Prisma connected to database
‚úÖ Redis initialized successfully
‚úÖ WebSocket server started on port 3002
üì° Waiting for connections...
```

### –õ–æ–∫–∞–ª—å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
```bash
curl -i -N -H 'Upgrade: websocket' http://localhost:3002
# –†–µ–∑—É–ª—å—Ç–∞—Ç: HTTP/1.1 101 Switching Protocols ‚úÖ
```

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Nginx
```bash
curl -k -i -N -H 'Upgrade: websocket' https://fonana.me/ws
# –†–µ–∑—É–ª—å—Ç–∞—Ç: HTTP/1.1 101 Switching Protocols ‚úÖ
# –ó–∞—Ç–µ–º: "Unauthorized" (–æ–∂–∏–¥–∞–µ–º–æ –±–µ–∑ JWT)
```

### API —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
```bash
curl -k -i https://fonana.me/api/user/notifications
# –†–µ–∑—É–ª—å—Ç–∞—Ç: HTTP/1.1 401 Unauthorized ‚úÖ
# {"error":"Authentication required"}
```

## –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –î–µ—Ç–∞–ª–∏ |
|-----------|--------|---------|
| WebSocket —Å–µ—Ä–≤–µ—Ä | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ü–æ—Ä—Ç 3002, PM2 –ø—Ä–æ—Ü–µ—Å—Å ID 3 |
| Nginx –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | /ws ‚Üí localhost:3002 |
| JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –¢—Ä–µ–±—É–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π —Ç–æ–∫–µ–Ω |
| API —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401 –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ |
| –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö | ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∞ | Prisma —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ |
| Redis | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | –ü–æ–¥–∫–ª—é—á–µ–Ω –¥–ª—è pub/sub |

## –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

1. **websocket-server/index.js** - –¥–æ–±–∞–≤–ª–µ–Ω —è–≤–Ω—ã–π –ø—É—Ç—å –∫ .env —Ñ–∞–π–ª—É
2. **nginx/sites-enabled** - –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è fonana

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ `pm2 status fonana-ws`
2. **–õ–æ–≥–∏**: –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å–º–æ—Ç—Ä–µ—Ç—å `/root/.pm2/logs/fonana-ws-error.log`
3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `/test-websocket-notifications.html` –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã WebSocket –∏ —Å–∏—Å—Ç–µ–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª–Ω–æ—Å—Ç—å—é —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã. –°–µ—Ä–≤–∏—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é. –ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π - —Å–æ—á–µ—Ç–∞–Ω–∏–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –Ω–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx.

–¢–µ–ø–µ—Ä—å –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –º–æ–≥—É—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –∫ WebSocket —Å–µ—Ä–≤–µ—Ä—É —á–µ—Ä–µ–∑ wss://fonana.me/ws —Å –≤–∞–ª–∏–¥–Ω—ã–º JWT —Ç–æ–∫–µ–Ω–æ–º. 