#!/bin/bash

echo "ðŸ”§ ÐŸÐžÐ›ÐÐžÐ• Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð• FONANA ÐÐ Ð¡Ð•Ð Ð’Ð•Ð Ð•"
echo "========================================"
echo ""
echo "Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚:"
echo "1. ÐŸÐ¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚"
echo "2. ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ Ð²ÑÐµ ÐºÐ¾ÑÑ‚Ñ‹Ð»Ð¸ Ð¸ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÑ‹"
echo "3. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ Ð¿Ñ€Ð¾ÐµÐºÑ‚ Ð·Ð°Ð½Ð¾Ð²Ð¾ Ñ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ð¼Ð¸"
echo ""

echo "Ð’Ð«ÐŸÐžÐ›ÐÐ˜Ð¢Ð• ÐÐ Ð¡Ð•Ð Ð’Ð•Ð Ð•:"
echo ""
echo "ssh -p 43988 root@69.10.59.234"
echo ""
echo "# 1. ÐŸÐžÐ›ÐÐÐ¯ ÐžÐ¡Ð¢ÐÐÐžÐ’ÐšÐ Ð˜ ÐžÐ§Ð˜Ð¡Ð¢ÐšÐ"
echo "systemctl stop fonana"
echo "systemctl disable fonana"
echo "pkill -9 -f node"
echo "pkill -9 -f npm"
echo "rm -rf /var/www/fonana"
echo "rm -f /etc/systemd/system/fonana.service"
echo "rm -f /etc/nginx/sites-enabled/fonana"
echo "rm -f /etc/nginx/sites-available/fonana"
echo "systemctl daemon-reload"
echo ""
echo "# 2. Ð¡ÐžÐ—Ð”ÐÐÐ˜Ð• Ð§Ð˜Ð¡Ð¢ÐžÐ™ Ð¡Ð¢Ð Ð£ÐšÐ¢Ð£Ð Ð«"
echo "mkdir -p /var/www/fonana"
echo "cd /var/www/fonana"
echo ""
echo "# 3. Ð ÐÐ¡ÐŸÐÐšÐžÐ’ÐšÐ ÐÐžÐ’Ð«Ð¥ Ð¤ÐÐ™Ð›ÐžÐ’"
echo "tar -xzf /tmp/fonana-clean-deploy.tar.gz"
echo ""
echo "# 4. Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ Ð—ÐÐ’Ð˜Ð¡Ð˜ÐœÐžÐ¡Ð¢Ð•Ð™"
echo "npm install --production"
echo ""
echo "# 5. Ð¡ÐžÐ—Ð”ÐÐÐ˜Ð• ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐžÐ“Ðž SYSTEMD Ð¡Ð•Ð Ð’Ð˜Ð¡Ð"
echo "cat > /etc/systemd/system/fonana.service << 'EOF'"
echo "[Unit]"
echo "Description=Fonana Web3 Platform"
echo "After=network.target"
echo ""
echo "[Service]"
echo "Type=simple"
echo "User=root"
echo "WorkingDirectory=/var/www/fonana"
echo "ExecStart=/usr/bin/npm start"
echo "Environment=\"NODE_ENV=production\""
echo "Environment=\"PORT=3001\""
echo "Environment=\"HOSTNAME=0.0.0.0\""
echo "Restart=always"
echo "RestartSec=10"
echo ""
echo "[Install]"
echo "WantedBy=multi-user.target"
echo "EOF"
echo ""
echo "# 6. Ð¡ÐžÐ—Ð”ÐÐÐ˜Ð• ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐžÐ™ ÐšÐžÐÐ¤Ð˜Ð“Ð£Ð ÐÐ¦Ð˜Ð˜ NGINX"
echo "cat > /etc/nginx/sites-available/fonana << 'EOF'"
echo "server {"
echo "    listen 80;"
echo "    server_name fonana.me www.fonana.me;"
echo "    return 301 https://\$server_name\$request_uri;"
echo "}"
echo ""
echo "server {"
echo "    listen 443 ssl http2;"
echo "    server_name fonana.me www.fonana.me;"
echo ""
echo "    ssl_certificate /etc/letsencrypt/live/fonana.me/fullchain.pem;"
echo "    ssl_certificate_key /etc/letsencrypt/live/fonana.me/privkey.pem;"
echo ""
echo "    # Next.js static files - ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐ«Ð• ÐŸÐ£Ð¢Ð˜"
echo "    location /_next/static/ {"
echo "        alias /var/www/fonana/.next/static/;"
echo "        expires 1y;"
echo "        add_header Cache-Control \"public, immutable\";"
echo "        access_log off;"
echo "    }"
echo ""
echo "    # Public files"
echo "    location /public/ {"
echo "        alias /var/www/fonana/public/;"
echo "        expires 1y;"
echo "        add_header Cache-Control \"public\";"
echo "        access_log off;"
echo "    }"
echo ""
echo "    # Proxy to Next.js"
echo "    location / {"
echo "        proxy_pass http://localhost:3001;"
echo "        proxy_http_version 1.1;"
echo "        proxy_set_header Upgrade \$http_upgrade;"
echo "        proxy_set_header Connection 'upgrade';"
echo "        proxy_set_header Host \$host;"
echo "        proxy_cache_bypass \$http_upgrade;"
echo "    }"
echo "}"
echo "EOF"
echo ""
echo "# 7. ÐŸÐ•Ð Ð•Ð¡Ð‘ÐžÐ ÐšÐ ÐÐ Ð¡Ð•Ð Ð’Ð•Ð Ð• (Ð’ÐÐ–ÐÐž!)"
echo "cd /var/www/fonana"
echo "rm -rf .next"
echo "npm run build"
echo ""
echo "# 8. ÐÐšÐ¢Ð˜Ð’ÐÐ¦Ð˜Ð¯ Ð˜ Ð—ÐÐŸÐ£Ð¡Ðš"
echo "ln -sf /etc/nginx/sites-available/fonana /etc/nginx/sites-enabled/"
echo "nginx -t && systemctl reload nginx"
echo "systemctl daemon-reload"
echo "systemctl enable fonana"
echo "systemctl start fonana"
echo ""
echo "# 9. ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ"
echo "sleep 5"
echo "systemctl status fonana"
echo "curl -I https://fonana.me"
echo ""
echo "========================================"
echo "âœ… ÐŸÐ¾ÑÐ»Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð²ÑÐµÑ… ÐºÐ¾Ð¼Ð°Ð½Ð´ ÑÐ°Ð¹Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ð±ÐµÐ· Ð¾ÑˆÐ¸Ð±Ð¾Ðº!" 