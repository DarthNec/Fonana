# Система платежей и реферальная монетизация Fonana

## Обзор

Fonana использует блокчейн Solana для всех платежей. Система включает:
- Подписки на создателей
- Платные посты
- Реферальную программу с автоматическим распределением комиссий

## Распределение платежей

### Подписки

При оплате подписки средства распределяются следующим образом:

**Без реферера:**
- Создатель: 90%
- Платформа: 10%

**С реферером:**
- Создатель: 90%
- Платформа: 5%
- Реферер: 5%

### Платные посты

Аналогичное распределение:

**Без реферера:**
- Создатель: 90%
- Платформа: 10%

**С реферером:**
- Создатель: 90%
- Платформа: 5%
- Реферер: 5%

## Техническая реализация

### 1. Определение реферера

При регистрации система проверяет cookie `fonana_referrer`, который устанавливается при переходе по реферальной ссылке:

```typescript
// middleware.ts
if (request.nextUrl.pathname.match(/^\/[a-zA-Z0-9_-]+$/)) {
  response.cookies.set('fonana_referrer', nickname, {
    maxAge: 60 * 60 * 24 * 7, // 7 дней
    httpOnly: true,
    sameSite: 'lax',
    secure: process.env.NODE_ENV === 'production'
  })
}
```

### 2. Создание транзакций

Все платежи проходят через функции в `lib/solana/payments.ts`:

```typescript
// Расчет распределения платежа
const distribution = calculatePaymentDistribution(
  amount,
  creatorWallet,
  hasReferrer,
  referrerWallet
)

// Создание транзакции
const transaction = await createSubscriptionTransaction(
  publicKey,
  distribution
)
```

### 3. Отслеживание платежей

Все транзакции сохраняются в БД:

```prisma
model Transaction {
  id              String   @id @default(cuid())
  type            TransactionType
  status          TransactionStatus
  amount          Float
  platformFee     Float?
  referrerFee     Float?
  referrerWallet  String?
  // ... другие поля
}
```

## Страница рефералов

Пользователи могут отслеживать свои реферальные доходы на странице `/dashboard/referrals`:

### Функции страницы:

1. **Обзор доходов**
   - Общий заработок
   - Количество рефералов
   - Активные создатели
   - Количество транзакций

2. **Детализация по типам**
   - Доход от подписок
   - Доход от платных постов
   - Группировка по валютам (SOL, USDC)

3. **История транзакций**
   - Последние реферальные комиссии
   - Информация о покупателе и создателе
   - Дата и сумма комиссии

## API Endpoints

### Получение статистики по рефералам
```
GET /api/user/referral-earnings?userId={userId}
```

Возвращает:
```json
{
  "totalEarnings": 12.5,
  "totalTransactions": 25,
  "earningsByType": {
    "subscriptions": 10.0,
    "posts": 2.5
  },
  "earningsByCurrency": {
    "SOL": 12.5
  },
  "recentTransactions": [...]
}
```

### Обработка платежа за пост
```
POST /api/posts/process-payment
```

Тело запроса:
```json
{
  "postId": "123",
  "userId": "wallet_address",
  "price": 0.5,
  "currency": "SOL",
  "signature": "tx_signature",
  "creatorId": "456",
  "hasReferrer": true,
  "distribution": {...}
}
```

## Компоненты

### PurchaseModal
Модальное окно для покупки платного контента. Автоматически:
- Загружает данные создателя с информацией о реферере
- Показывает распределение платежа
- Создает и отправляет транзакцию

### SubscriptionPayment
Компонент для оплаты подписок. Функции:
- Выбор тарифного плана
- Расчет и отображение комиссий
- Обработка платежа через Solana

## Безопасность

1. **Валидация кошельков**
   - Проверка корректности адресов Solana
   - Защита от некорректных адресов

2. **Проверка транзакций**
   - Сохранение signature транзакций
   - Возможность верификации в блокчейне

3. **Защита от мошенничества**
   - Cookie httpOnly для защиты от XSS
   - Проверка referrerId при создании пользователя

## Будущие улучшения

1. **Многоуровневая реферальная система**
   - Комиссии от рефералов второго уровня
   - Бонусы за активных рефералов

2. **Аналитика для создателей**
   - Статистика по источникам трафика
   - Конверсия рефералов в подписчиков

3. **Автоматические выплаты**
   - Вывод средств по расписанию
   - Минимальные суммы для вывода

4. **NFT подписки**
   - Использование NFT как proof of subscription
   - Торговля подписками на вторичном рынке 