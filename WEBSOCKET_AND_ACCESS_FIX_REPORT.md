# ะััะตั ะพ ะบะพะผะฟะปะตะบัะฝะพะผ ััััะฐะฝะตะฝะธะธ ะฟัะพะฑะปะตะผ ั WebSocket ะธ ะดะพัััะฟะพะผ ะบ ะฟะปะฐัะฝัะผ ะฟะพััะฐะผ

## ะะฐัะฐ: 28 ะธัะฝั 2025

## ะััะฒะปะตะฝะฝัะต ะฟัะพะฑะปะตะผั

### 1. WebSocket ะฝะต ะฟะพะดะบะปััะฐะปัั
- **ะกะธะผะฟัะพะผ**: WebSocket ัะตัะฒะตั ัะฐะฑะพัะฐะป, ะฝะพ ะบะปะธะตะฝัั ะฝะต ะผะพะณะปะธ ะฟะพะดะบะปััะธัััั
- **ะัะธัะธะฝะฐ**: ะััััััะฒะพะฒะฐะปะธ ะบัะธัะธัะตัะบะธ ะฒะฐะถะฝัะต ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั:
  - `NEXTAUTH_SECRET` - ะดะปั JWT ะฐััะตะฝัะธัะธะบะฐัะธะธ
  - `DATABASE_URL` - ะดะปั ะฟะพะดะบะปััะตะฝะธั ะบ ะฑะฐะทะต ะดะฐะฝะฝัั
- **ะะพะฟะพะปะฝะธัะตะปัะฝะฐั ะฟัะพะฑะปะตะผะฐ**: ะะตะฟัะฐะฒะธะปัะฝัะน ัะบัะฟะพัั prisma ะบะปะธะตะฝัะฐ

### 2. JWT ะฐััะตะฝัะธัะธะบะฐัะธั ะฝะต ัะฐะฑะพัะฐะปะฐ
- **ะกะธะผะฟัะพะผ**: ะขะพะบะตะฝั ะพัะบะปะพะฝัะปะธัั ั ะพัะธะฑะบะพะน "Unauthorized"
- **ะัะธัะธะฝั**:
  - PM2 ะฝะต ะทะฐะณััะถะฐะป ะฟะตัะตะผะตะฝะฝัะต ะธะท .env ัะฐะนะปะฐ
  - ะะตะฟัะฐะฒะธะปัะฝัะน ัะตััะพะฒัะน userId ะฒ test-client.js
  - Prisma ัะบัะฟะพััะธัะพะฒะฐะปัั ะดะพ ะธะฝะธัะธะฐะปะธะทะฐัะธะธ

## ะะตะฐะปะธะทะพะฒะฐะฝะฝัะต ัะตัะตะฝะธั

### ะคะฐะทะฐ 1 โ ะัะฟัะฐะฒะปะตะฝะธะต WebSocket ะฟะพะดะบะปััะตะฝะธั โ

1. **ะะฑะฝะพะฒะปะตะฝ ecosystem.config.js ะดะปั WebSocket ัะตัะฒะตัะฐ**:
   ```javascript
   env: {
     NODE_ENV: 'production',
     PORT: 3002,
     WS_PORT: 3002,
     NEXTAUTH_SECRET: 'your-secret-key',
     DATABASE_URL: 'postgresql://postgres:postgres@localhost:5432/fonana_dev?schema=public'
   }
   ```

2. **ะัะฟัะฐะฒะปะตะฝ ัะบัะฟะพัั prisma ะฒ db.js**:
   - ะะพะฑะฐะฒะปะตะฝะฐ ััะฝะบัะธั `getPrisma()` ะดะปั ะฟะพะปััะตะฝะธั ะธะฝะธัะธะฐะปะธะทะธัะพะฒะฐะฝะฝะพะณะพ ะบะปะธะตะฝัะฐ
   - ะฃะฑัะฐะฝ ะฟััะผะพะน ัะบัะฟะพัั ะฝะตะธะฝะธัะธะฐะปะธะทะธัะพะฒะฐะฝะฝะพะน ะฟะตัะตะผะตะฝะฝะพะน

3. **ะะฑะฝะพะฒะปะตะฝ auth.js**:
   - ะัะฟะพะปัะทัะตั `getPrisma()` ะฒะผะตััะพ ะฟััะผะพะณะพ ะธะผะฟะพััะฐ
   - ะะพะฑะฐะฒะปะตะฝะฐ ะพะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ ะธะฝะธัะธะฐะปะธะทะฐัะธะธ

4. **ะัะฟัะฐะฒะปะตะฝ test-client.js**:
   - ะัะฟะพะปัะทัะตั ัะตะฐะปัะฝัะน userId ะธะท ะฑะฐะทั ะดะฐะฝะฝัั: `cmcceumg7001iyjleslvczux6`

### ะคะฐะทะฐ 2 โ ะัะพะฒะตัะบะฐ ะธ ััะฐะฑะธะปะธะทะฐัะธั ะดะพัััะฟะฐ โ

WebSocket ัะตัะฒะตั ัะตะฟะตัั:
- โ ะฃัะฟะตัะฝะพ ะฐััะตะฝัะธัะธัะธััะตั JWT ัะพะบะตะฝั
- โ ะัะพะฒะตััะตั ะฟะพะปัะทะพะฒะฐัะตะปะตะน ะฒ ะฑะฐะทะต ะดะฐะฝะฝัั
- โ ะะพะดะบะปััะฐะตััั ะบ PostgreSQL ัะตัะตะท Prisma
- โ ะัะฟัะฐะฒะปัะตั real-time ัะพะฑััะธั ะฟะพะดะฟะธััะธะบะฐะผ

### ะคะฐะทะฐ 3 โ ะขะตััะธัะพะฒะฐะฝะธะต โ

ะฃัะฟะตัะฝะพ ะฟัะพัะตััะธัะพะฒะฐะฝั ััะตะฝะฐัะธะธ:
1. **ะะพะดะบะปััะตะฝะธะต ั ะฒะฐะปะธะดะฝัะผ ัะพะบะตะฝะพะผ** - โ ะะฐะฑะพัะฐะตั
2. **ะะพะดะฟะธัะบะฐ ะฝะฐ ะบะฐะฝะฐะปั** - โ ะะฐะฑะพัะฐะตั
3. **Ping-pong ะฟัะพะฒะตัะบะฐ** - โ ะะฐะฑะพัะฐะตั
4. **ะัะบะฐะท ะฒ ะดะพัััะฟะต ะบ ััะถะธะผ ะบะฐะฝะฐะปะฐะผ** - โ ะะฐะฑะพัะฐะตั
5. **Graceful disconnect** - โ ะะฐะฑะพัะฐะตั

## ะะตะทัะปััะฐัั

### ะกัะฐััั WebSocket ัะตัะฒะตัะฐ:
```
โโโโโโฌโโโโโโโโโโโโโโโฌโโโโโโโโโโฌโโโโโโโโโโโฌโโโโโโโโโฌโโโโโโโฌโโโโโโโโโโโโ
โ id โ name         โ version โ pid      โ uptime โ โบ    โ status    โ
โโโโโโผโโโโโโโโโโโโโโโผโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโผโโโโโโโผโโโโโโโโโโโโค
โ 4  โ fonana-ws    โ 1.0.0   โ 1938430  โ 5m     โ 3    โ online    โ
โโโโโโดโโโโโโโโโโโโโโโดโโโโโโโโโโดโโโโโโโโโโโดโโโโโโโโโดโโโโโโโดโโโโโโโโโโโโ
```

### ะขะตััะพะฒัะน ะฒัะฒะพะด:
```
โ Connected to WebSocket server
๐จ Received: {
  "type": "connected",
  "data": {
    "userId": "cmcceumg7001iyjleslvczux6",
    "message": "Successfully connected to WebSocket server"
  }
}
```

## ะะปััะตะฒัะต ะธะทะผะตะฝะตะฝะธั ะฒ ัะฐะนะปะฐั

1. `websocket-server/ecosystem.config.js` - ะดะพะฑะฐะฒะปะตะฝั env ะฟะตัะตะผะตะฝะฝัะต
2. `websocket-server/src/db.js` - ะธัะฟัะฐะฒะปะตะฝ ัะบัะฟะพัั prisma
3. `websocket-server/src/auth.js` - ะธัะฟะพะปัะทัะตั getPrisma()
4. `websocket-server/test-client.js` - ะฟัะฐะฒะธะปัะฝัะน userId

## ะะตะบะพะผะตะฝะดะฐัะธะธ

1. **ะะตะทะพะฟะฐัะฝะพััั**: ะ ะฟัะพะดะฐะบัะฝะต ะฝะตะพะฑัะพะดะธะผะพ ะธัะฟะพะปัะทะพะฒะฐัั ะฝะฐััะพััะธะน NEXTAUTH_SECRET ะฒะผะตััะพ 'your-secret-key'
2. **ะะพะฝะธัะพัะธะฝะณ**: ะกะปะตะดะธัั ะทะฐ ะบะพะปะธัะตััะฒะพะผ ัะตััะฐััะพะฒ WebSocket ัะตัะฒะตัะฐ ัะตัะตะท PM2
3. **ะะฐะทะฐ ะดะฐะฝะฝัั**: ะฃะฑะตะดะธัััั ััะพ DATABASE_URL ัะบะฐะทัะฒะฐะตั ะฝะฐ ะฟัะฐะฒะธะปัะฝัั ะฑะฐะทั (ัะตะนัะฐั fonana_dev)

## ะะฐะบะปััะตะฝะธะต

โ WebSocket ัะตัะฒะตั ะฟะพะปะฝะพัััั ััะฝะบัะธะพะฝะฐะปะตะฝ  
โ JWT ะฐััะตะฝัะธัะธะบะฐัะธั ัะฐะฑะพัะฐะตั ะบะพััะตะบัะฝะพ  
โ ะกะพะฑััะธั ะดะพััะฐะฒะปััััั ะฒ real-time  
โ ะกะธััะตะผะฐ ะณะพัะพะฒะฐ ะดะปั ะพะฑัะฐะฑะพัะบะธ ัะพะฑััะธะน `subscription-updated` ะธ `post-purchased`  
โ ะััะธัะตะบัััะฐ ะพััะฐะตััั ัะธััะพะน ะธ ะฟะพะดะดะตัะถะธะฒะฐะตะผะพะน 