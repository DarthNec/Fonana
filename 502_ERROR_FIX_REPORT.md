# Отчет об устранении ошибки 502 на продакшне Fonana

## Дата: 28 июня 2025 г.
## Время: 04:50 - 04:56 MSK

### Исходная проблема
- **Симптом**: Сайт fonana.me возвращал ошибку 502 Bad Gateway
- **Причина**: Процесс Next.js упал и не мог запуститься из-за отсутствия продакшн сборки

### Диагностика

1. **Проверка статуса PM2**:
   - Процесс `fonana` был в статусе `errored` с 16 перезапусками
   - Процесс `fonana-ws` работал нормально

2. **Анализ логов**:
   - Ошибка: `ENOENT: no such file or directory, open '/var/www/fonana/.next/routes-manifest.json'`
   - Причина: Отсутствовала продакшн сборка (директория `.next`)

### Выполненные действия

1. **Обновление кода**:
   ```bash
   git stash --include-untracked
   git pull
   ```
   - Сохранены локальные изменения
   - Обновлен код из репозитория (коммит b859700)

2. **Установка зависимостей**:
   ```bash
   npm install
   npm install jsonwebtoken @types/jsonwebtoken
   ```
   - Установлены все зависимости
   - Добавлены недостающие пакеты для JWT

3. **Сборка проекта**:
   ```bash
   npm run build
   ```
   - Успешная сборка Next.js для продакшна
   - Сгенерированы все необходимые файлы

4. **Перезапуск процессов**:
   ```bash
   pm2 delete fonana
   pm2 start ecosystem.config.js
   ```
   - Удален сбойный процесс
   - Запущен новый процесс из конфигурации

5. **Перезагрузка Nginx**:
   ```bash
   systemctl reload nginx
   ```

### Результат

✅ **Ошибка 502 устранена**
- Сайт доступен и возвращает код 200 OK
- Процесс `fonana` работает стабильно (0 перезапусков)
- API endpoints функционируют корректно
- Система работает на стандартном порту 3000

### Финальный статус PM2
```
┌────┬──────────────┬─────────┬──────┬───────────┬─────────┬─────────┬──────────┐
│ id │ name         │ version │ ↺    │ status    │ cpu     │ mem     │ user     │
├────┼──────────────┼─────────┼──────┼───────────┼─────────┼─────────┼──────────┤
│ 2  │ fonana       │ N/A     │ 0    │ online    │ 0%      │ 57.7mb  │ root     │
│ 1  │ fonana-ws    │ 1.0.0   │ 20   │ online    │ 0%      │ 72.1mb  │ root     │
└────┴──────────────┴─────────┴──────┴───────────┴─────────┴─────────┴──────────┘
```

### Рекомендации

1. **Предотвращение повторения**:
   - Всегда проверять наличие сборки после деплоя
   - Использовать скрипт `deploy-to-production.sh` который автоматически собирает проект
   - Не удалять `.next` директорию без немедленной пересборки

2. **Мониторинг**:
   - Настроить алерты при падении процессов
   - Регулярно проверять `pm2 status`
   - Следить за логами ошибок

### Заключение
Проблема полностью устранена. Сайт работает стабильно в продакшн режиме без временных решений и обходных путей. 