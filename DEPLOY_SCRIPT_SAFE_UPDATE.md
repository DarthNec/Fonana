# Безопасное обновление скрипта деплоя

## Дата: 26 июня 2025

## Проблема
Старый скрипт `deploy-to-production.sh` использовал множественные SSH-соединения и агрессивный `pkill -f node`, что приводило к:
- Разрыву SSH-соединения при убийстве процессов
- Неполному выполнению деплоя
- Необходимости завершать деплой вручную

## Решение
Скрипт полностью переписан для работы в едином SSH-соединении с безопасной остановкой процессов.

### Основные изменения:

1. **Единое SSH-соединение**
   - Все команды выполняются в одной SSH-сессии через heredoc
   - Используется `ssh ... 'bash -s' << 'DEPLOY_SCRIPT'`
   - Исключены промежуточные разрывы соединения

2. **Безопасная остановка процессов**
   ```bash
   # Сначала PM2
   pm2 stop all
   pm2 delete all
   
   # Затем graceful shutdown для node процессов
   kill -TERM $pid  # вместо kill -9
   sleep 2          # даем время на завершение
   kill -9 $pid     # force kill если еще работает
   ```

3. **Точечная очистка**
   - Убиваем только процессы из `/var/www/fonana`
   - Используем while loop вместо xargs для контроля
   - Исключаем SSH и системные процессы

4. **Обработка ошибок**
   - `set -e` внутри SSH-сессии
   - `|| true` для некритичных команд
   - Проверки на пустые переменные

5. **Последовательность операций**
   - Все шаги выполняются строго последовательно
   - Нет параллельных SSH-соединений
   - Версионирование после основного деплоя

## Использование

```bash
# Как и раньше
./deploy-to-production.sh
```

## Преимущества нового подхода

1. **Надежность**: Деплой не прерывается из-за разрыва соединения
2. **Безопасность**: Не убиваем системные процессы или SSH
3. **Предсказуемость**: Все команды выполняются последовательно
4. **Отладка**: Единый лог выполнения, легче найти проблемы
5. **Graceful shutdown**: Процессы завершаются корректно

## Резервная копия

Старый скрипт сохранен как `deploy-to-production.sh.backup-20250626-194518`

## Если возникли проблемы

1. Проверьте статус:
   ```bash
   ./scripts/devops-status.sh
   ```

2. Посмотрите логи PM2 (безопасно):
   ```bash
   ssh -p 43988 root@69.10.59.234 "pm2 logs fonana --lines 50 --nostream"
   ```

3. Вернитесь к старому скрипту:
   ```bash
   cp deploy-to-production.sh.backup-20250626-194518 deploy-to-production.sh
   ```

## Тестирование

Новый скрипт был протестирован на:
- Корректную остановку процессов
- Сохранение SSH-соединения
- Полное выполнение всех шагов
- Правильный перезапуск приложения 