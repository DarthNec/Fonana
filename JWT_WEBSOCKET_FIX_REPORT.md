# –û—Ç—á—ë—Ç –æ —Å–∏—Å—Ç–µ–º–Ω–æ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ JWT, WebSocket –∏ real-time —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ Fonana

**–î–∞—Ç–∞**: 29 –∏—é–Ω—è 2025  
**–í—Ä–µ–º—è**: 16:00 - 16:35 UTC  
**–ê–≤—Ç–æ—Ä**: AI Assistant  
**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø  

## –†–µ–∑—é–º–µ

‚úÖ **–°–∏—Å—Ç–µ–º–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è JWT –∏ WebSocket –≤–Ω–µ–¥—Ä–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ**

–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º JWT —Ç–æ–∫–µ–Ω–æ–≤ –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º WebSocket —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã. –î–æ–±–∞–≤–ª–µ–Ω–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏. –°–æ–∑–¥–∞–Ω–∞ —Ç–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏.

## –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ API –≤ JWT Manager
- **–°–∏–º–ø—Ç–æ–º**: –§—Ä–æ–Ω—Ç–µ–Ω–¥ –æ–∂–∏–¥–∞–ª –ø–æ–ª–µ `success` –≤ –æ—Ç–≤–µ—Ç–µ, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ –±—ã–ª–æ
- **–ü—Ä–∏—á–∏–Ω–∞**: API –≤–æ–∑–≤—Ä–∞—â–∞–ª —Ç–æ–ª—å–∫–æ `{ token, user }`, –Ω–æ –∫–æ–¥ –ø—Ä–æ–≤–µ—Ä—è–ª –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –ø–æ–ª–µ
- **–í–ª–∏—è–Ω–∏–µ**: JWT —Ç–æ–∫–µ–Ω—ã —Å—á–∏—Ç–∞–ª–∏—Å—å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏

### 2. –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–µ—Ä–µ–¥–∞—á–µ–π –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–∞
- **–°–∏–º–ø—Ç–æ–º**: –ü–æ–ø—ã—Ç–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—è `expiresIn`
- **–ü—Ä–∏—á–∏–Ω–∞**: API –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–ª —ç—Ç–æ –ø–æ–ª–µ
- **–í–ª–∏—è–Ω–∏–µ**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞

### 3. WebSocket –Ω–µ –ø–æ–ª—É—á–∞–ª JWT —Ç–æ–∫–µ–Ω
- **–°–∏–º–ø—Ç–æ–º**: –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ "No token provided"
- **–ü—Ä–∏—á–∏–Ω–∞**: –ü—Ä–æ–±–ª–µ–º—ã —Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º –ø–æ–ª—É—á–µ–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–∞
- **–í–ª–∏—è–Ω–∏–µ**: WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –æ—Ç–∫–ª–æ–Ω—è–ª–∏—Å—å

### 4. Nginx –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
- **–°–∏–º–ø—Ç–æ–º**: –¢–æ–∫–µ–Ω –≤ URL —Ç–µ—Ä—è–ª—Å—è –ø—Ä–∏ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–∏
- **–ü—Ä–∏—á–∏–Ω–∞**: –û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª `$request_uri` –≤ proxy_pass
- **–í–ª–∏—è–Ω–∏–µ**: WebSocket —Å–µ—Ä–≤–µ—Ä –Ω–µ –≤–∏–¥–µ–ª —Ç–æ–∫–µ–Ω

## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### ‚úÖ –≠—Ç–∞–ø 1 ‚Äî –ê—É–¥–∏—Ç –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API –≤—ã–¥–∞—á–∏ JWT
```typescript
// –ë—ã–ª–æ:
if (!data.success || !data.token) {
  console.error('[JWT] Invalid response:', data)
  return null
}

// –°—Ç–∞–ª–æ:
if (!data.token) {
  console.error('[JWT] Invalid response:', data)
  return null
}
```

### ‚úÖ –≠—Ç–∞–ø 2 ‚Äî –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ JWT –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ
```typescript
// –ë—ã–ª–æ:
const expiresIn = this.parseExpiresIn(data.expiresIn)

// –°—Ç–∞–ª–æ:
const expiresIn = 30 * 24 * 60 * 60 * 1000 // 30 –¥–Ω–µ–π –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
```

### ‚úÖ –≠—Ç–∞–ø 3 ‚Äî –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è WebSocket
1. **–û–±–Ω–æ–≤–ª–µ–Ω–∞ nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**:
```nginx
location /ws {
    proxy_pass http://localhost:3002$request_uri;
    proxy_set_header Authorization $http_authorization;
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
}
```

2. **–î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∞ –∞–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è**:
```typescript
if (typeof window !== 'undefined') {
  setTimeout(() => {
    console.log('[WebSocket] Initiating auto-connect...')
    wsService.connect()
  }, 1000)
}
```

3. **–†–∞—Å—à–∏—Ä–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**:
- JWT Manager –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ —ç—Ç–∞–ø—ã –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
- WebSocket Service –ª–æ–≥–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- –î–æ–±–∞–≤–ª–µ–Ω—ã –æ—Ç–ª–∞–¥–æ—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è

### ‚úÖ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–°–æ–∑–¥–∞–Ω–∞ —Ç–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ `/test/jwt-debug`**:
- –í–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ JWT –∏ WebSocket
- –ö–Ω–æ–ø–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤
- –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

2. **–û–±–Ω–æ–≤–ª–µ–Ω—ã —Ñ–∞–π–ª—ã**:
- `lib/utils/jwt.ts` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤
- `lib/services/websocket.ts` - —É–ª—É—á—à–µ–Ω –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- `app/test/jwt-debug/page.tsx` - —Å–æ–∑–¥–∞–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- `/etc/nginx/sites-enabled/fonana-me` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. JWT —Ç–æ–∫–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
2. –ö–ª–∏–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç API
3. –¢–æ–∫–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ localStorage —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º TTL
4. WebSocket –ø–æ–ª—É—á–∞–µ—Ç URL —Å —Ç–æ–∫–µ–Ω–æ–º –≤ query –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö
5. Nginx –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

### ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏:
1. –†–µ–∞–ª—å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WebSocket —Å –≤–∞–ª–∏–¥–Ω—ã–º JWT
2. –†–∞–±–æ—Ç–∞ real-time —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
3. –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ

## –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

1. **–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏**:
   ```
   https://fonana.me/test/jwt-debug
   ```

2. **–í—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ—Å—Ç—ã**:
   - Connect Wallet ‚Üí –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫
   - Test Auth API ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ JWT
   - Test Full JWT Flow ‚Üí –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç JWT + WebSocket

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞**:
   - –°–æ–æ–±—â–µ–Ω–∏—è `[JWT]` –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ä–∞–±–æ—Ç—É —Å —Ç–æ–∫–µ–Ω–∞–º–∏
   - –°–æ–æ–±—â–µ–Ω–∏—è `[WebSocket]` –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:
```bash
ssh -p 43988 root@69.10.59.234 "pm2 status"
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ WebSocket:
```bash
ssh -p 43988 root@69.10.59.234 "pm2 logs fonana-ws --lines 50"
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π:
```bash
ssh -p 43988 root@69.10.59.234 "netstat -an | grep :3002 | grep ESTABLISHED | wc -l"
```

## –í–µ—Ä—Å–∏—è —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–≥–æ –∫–æ–¥–∞
- **Commit**: 7701399
- **–í–µ—Ä—Å–∏—è**: 20250629-093250-7701399
- **–î–µ–ø–ª–æ–π**: –£—Å–ø–µ—à–Ω—ã–π, –æ–±–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–∞–±–æ—Ç–∞—é—Ç

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å**:
   - –†–µ–∞–ª—å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å –∫–æ—à–µ–ª—å–∫–æ–º
   - –û—Ç–ø—Ä–∞–≤–∫—É –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
   - –†–∞–±–æ—Ç—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

2. **–ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º**:
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É `/test/jwt-debug`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ —á–µ—Ä–µ–∑ `pm2 logs`
   - –û–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞

3. **–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è**:
   - –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—à–Ω—ã—Ö/–Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
   - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
   - –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–û—Å–Ω–æ–≤–Ω—ã–µ –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å JWT –∏ WebSocket —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã. –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é real-time —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞. –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Å—Ç–∏ –ø–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏. 