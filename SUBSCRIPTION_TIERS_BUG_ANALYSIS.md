# Анализ проблем с тирами подписок

## Выявленные проблемы

### 1. Некорректное отображение текущего тира подписки

**Проблема:** 
Пользователь с Premium подпиской видит кнопку "Upgrade to Premium" на странице автора.

**Причина:**
- В базе данных план сохраняется с большой буквы: 'Basic', 'Premium', 'VIP'
- В коде проверка идет с маленькой буквы: 'basic', 'premium', 'vip'
- Строгое сравнение `!==` не учитывает разницу в регистре

**Исправлено:**
- Добавлено приведение к нижнему регистру: `currentSubscriptionTier?.toLowerCase() !== 'premium'`

### 2. Подписка сбрасывается на Basic после оплаты

**Проблема:**
При попытке подписаться на lafufu подписка сбрасывается на Basic тир после успешной оплаты.

**Возможные причины:**
1. **Проверка цен в API** - жесткая проверка ожидаемых цен не учитывает кастомные настройки создателей
2. **Конфликт имен планов** - возможно, где-то в коде происходит переопределение плана
3. **Проблема с передачей параметров** - план может теряться при передаче между компонентами

**Диагностика:**
Создан скрипт `scripts/diagnose-dogwater-subscription.js` для анализа конкретной ситуации.

## Системные проблемы

### 1. Несогласованность названий планов

В системе используются разные форматы:
- База данных: 'Basic', 'Premium', 'VIP' (с большой буквы)
- Компоненты: 'basic', 'premium', 'vip' (с маленькой)
- API: ожидает точное совпадение

### 2. Жесткая проверка цен

В `app/api/subscriptions/process-payment/route.ts`:
```typescript
const expectedPrices: Record<string, number> = {
  'Basic': 0.05,
  'Premium': 0.15,
  'VIP': 0.35
}
```

Это не учитывает:
- Кастомные цены создателей
- Flash Sales скидки
- Динамическое ценообразование

### 3. Отсутствие валидации плана

При создании подписки нет проверки, что переданный план соответствует доступным планам создателя.

## Рекомендации

### Немедленные действия:
1. ✅ Исправить проверку тиров на странице автора (уже сделано)
2. Запустить диагностический скрипт для проверки подписок Dogwater
3. Проверить логи API для выявления точной причины сброса на Basic

### Долгосрочные улучшения:
1. **Стандартизировать названия планов** - использовать единый формат во всей системе
2. **Убрать жесткую проверку цен** - полагаться на настройки создателей
3. **Добавить валидацию планов** - проверять доступность плана перед созданием подписки
4. **Логирование** - улучшить логирование для отслеживания проблем с подписками
5. **Тесты** - добавить автоматические тесты для процесса подписки

## Проверка исправлений

После внедрения исправлений нужно проверить:
1. Корректное отображение текущего тира на странице автора
2. Сохранение правильного плана после оплаты
3. Работу с кастомными ценами создателей
4. Совместимость с Flash Sales 