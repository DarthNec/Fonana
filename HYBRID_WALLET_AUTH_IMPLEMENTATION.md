# üîê –ì–∏–±—Ä–∏–¥–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Solana –∫–æ—à–µ–ª–µ–∫

## üìã –û–±–∑–æ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≥–∏–±—Ä–∏–¥–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä–∞—è:
- ‚úÖ –ê–≤—Ç–æ—Ä–∏–∑—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ –ø–æ–¥–ø–∏—Å—å —Å–æ–æ–±—â–µ–Ω–∏—è Solana –∫–æ—à–µ–ª—å–∫–æ–º
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç JWT —Ç–æ–∫–µ–Ω –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
- ‚úÖ –ü–æ–¥–∫–ª—é—á–∞–µ—Ç –∫–æ—à–µ–ª–µ–∫ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –Ω—É–∂–Ω—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —á–µ—Ä–µ–∑ Mobile Wallet Adapter
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç UX –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### 1. JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (`/lib/auth/jwt.ts`)
```typescript
// –°–æ–∑–¥–∞–Ω–∏–µ JWT —Ç–æ–∫–µ–Ω–∞
const token = await createJWT({
  wallet: publicKey,
  userId: user.id
})

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
const payload = await verifyJWT(token)
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ Solana (`/lib/auth/solana.ts`)
```typescript
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–¥–ø–∏—Å–∏
const message = generateSignMessage()

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏
const isValid = verifySignature(message, signature, publicKey)

// –ó–∞—â–∏—Ç–∞ –æ—Ç replay –∞—Ç–∞–∫
const isMessageValid = isMessageValid(message, maxAgeMs)
```

### 3. API endpoint (`/api/auth/wallet`)
- **POST** - –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –ø–æ–¥–ø–∏—Å—å –∏–ª–∏ logout
- **GET** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### 4. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### `HybridWalletConnect` - –æ—Å–Ω–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
```tsx
import { HybridWalletConnect } from '@/components/HybridWalletConnect'

// –í Navbar –∏–ª–∏ –ª—é–±–æ–º –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ
<HybridWalletConnect />
```

#### `ConnectWalletOnDemand` - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é
```tsx
import { ConnectWalletOnDemand } from '@/components/ConnectWalletOnDemand'

// –í –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ –ø–æ–∫—É–ø–∫–∏
{!connected ? (
  <ConnectWalletOnDemand 
    message="–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫ –¥–ª—è –ø–æ–∫—É–ø–∫–∏"
    onConnect={() => handlePurchase()}
  />
) : (
  <button onClick={handlePurchase}>–ö—É–ø–∏—Ç—å</button>
)}
```

### 5. –•—É–∫ `useAuth` –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
```tsx
import { useAuth } from '@/lib/hooks/useAuth'

function MyComponent() {
  const { isAuthenticated, user, logout, needsWalletConnection } = useAuth()
  
  if (isAuthenticated) {
    return <div>–ü—Ä–∏–≤–µ—Ç, {user.nickname}!</div>
  }
}
```

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–∞–µ—Ç –∫–æ—à–µ–ª–µ–∫**
   - –ù–∞–∂–∏–º–∞–µ—Ç –Ω–∞ –∫–Ω–æ–ø–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
   - –í—ã–±–∏—Ä–∞–µ—Ç –∫–æ—à–µ–ª–µ–∫ (Phantom, Solflare –∏ –¥—Ä.)
   - –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Mobile Wallet Adapter

2. **–ó–∞–ø—Ä–æ—Å –ø–æ–¥–ø–∏—Å–∏**
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ —Å timestamp –∏ nonce
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ—à–µ–ª—å–∫–µ
   - –ü–æ–¥–ø–∏—Å—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∏
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è timestamp (–∑–∞—â–∏—Ç–∞ –æ—Ç replay)
   - –°–æ–∑–¥–∞–µ—Ç—Å—è/–Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ë–î

4. **–í—ã–¥–∞—á–∞ JWT —Ç–æ–∫–µ–Ω–∞**
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è JWT —Å userId –∏ wallet
   - –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ HttpOnly cookie
   - –ö–æ–ø–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage (fallback)

5. **–ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏**
   - JWT –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
   - –ö–æ—à–µ–ª–µ–∫ –Ω–µ –Ω—É–∂–µ–Ω –¥–ª—è —á—Ç–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
   - –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

## üì± –ú–æ–±–∏–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```typescript
const env = detectWalletEnvironment()
// env.isMobile - –º–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
// env.isPhantom - Phantom —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
// env.isInWalletBrowser - –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä –∫–æ—à–µ–ª—å–∫–∞
```

### UX –ø–æ–¥—Å–∫–∞–∑–∫–∏
- **–í –æ–±—ã—á–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ**: "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫"
- **–í–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ**: "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –∫–æ—à–µ–ª–µ–∫"
- **–ù–∞ –º–æ–±–∏–ª—å–Ω–æ–º**: Deeplink –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫—É Phantom

## üîß –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### SubscribeModal
```tsx
// –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
const { isAuthenticated } = useAuth()

// –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å ConnectWalletOnDemand –µ—Å–ª–∏ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω
{!connected && isAuthenticated ? (
  <ConnectWalletOnDemand 
    message="–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏"
  />
) : (
  // –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞
)}
```

### PurchaseModal
```tsx
// –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ SubscribeModal
{!connected && isAuthenticated ? (
  <ConnectWalletOnDemand 
    message="–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –ø–æ—Å—Ç–∞"
  />
) : (
  // –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ–∫—É–ø–∫–∏
)}
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```env
JWT_SECRET=your-secret-key # –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è NEXTAUTH_SECRET
NEXT_PUBLIC_SOLANA_RPC_URL=https://...
NEXT_PUBLIC_SOLANA_NETWORK=mainnet # –∏–ª–∏ devnet
```

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- JWT —Ç–æ–∫–µ–Ω—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã 7 –¥–Ω–µ–π
- –°–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã 5 –º–∏–Ω—É—Ç
- HttpOnly cookies –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç XSS
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

## üöÄ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ API route
```typescript
import { checkAuth } from '@/lib/auth/jwt'

export async function GET(req: NextRequest) {
  const auth = await checkAuth()
  
  if (!auth) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }
  
  // auth.userId –∏ auth.wallet –¥–æ—Å—Ç—É–ø–Ω—ã
}
```

### –ó–∞—â–∏—â–µ–Ω–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
```tsx
'use client'

import { useAuth } from '@/lib/hooks/useAuth'
import { useRouter } from 'next/navigation'
import { useEffect } from 'react'

export default function ProtectedPage() {
  const { isAuthenticated, isLoading } = useAuth()
  const router = useRouter()
  
  useEffect(() => {
    if (!isLoading && !isAuthenticated) {
      router.push('/')
    }
  }, [isAuthenticated, isLoading])
  
  if (isLoading) return <div>Loading...</div>
  if (!isAuthenticated) return null
  
  return <div>Protected content</div>
}
```

## üìù TODO

1. **–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É Mobile Wallet Adapter**
   - –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ç–∏–ø—ã –¥–ª—è @solana-mobile/wallet-adapter-mobile
   - –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö

2. **–£–ª—É—á—à–∏—Ç—å UX**
   - –î–æ–±–∞–≤–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
   - –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
   - –ó–∞–ø–æ–º–∏–Ω–∞—Ç—å –≤—ã–±–æ—Ä –∫–æ—à–µ–ª—å–∫–∞

3. **–†–∞—Å—à–∏—Ä–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª**
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ multiple wallets
   - –ë–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
   - Session management UI

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≥–∏–±—Ä–∏–¥–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä–∞—è:
- –ú–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–ª–∏—Ç–µ–ª—å–Ω—ã–µ —Å–µ—Å—Å–∏–∏ —á–µ—Ä–µ–∑ JWT
- –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
- –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–ª–∞–≤–Ω—ã–π UX –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π 