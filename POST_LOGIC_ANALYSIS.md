# Анализ логики постов Fonana

## Найденная проблема с isSellable

### Описание бага
Пользователь vizer36 сообщил, что галка "sellable" ставится автоматически при редактировании постов.

### Причина
В компоненте `EditPostModal` при отправке данных на сервер всегда передавалось поле:
```javascript
isSellable: post.isSellable || false
```

Если изначально поле было `null` или `undefined`, то `|| false` возвращало `false`, и это значение перезаписывало существующее в базе.

### Решение
Убрали передачу полей `isSellable`, `sellType` и `quantity` из EditPostModal. Эти поля должны управляться только при создании поста.

## Текущая архитектура постов

### Типы доступа к постам
1. **Free** - публичный пост, доступен всем
2. **Subscribers** - доступен подписчикам с тиром basic и выше
3. **Premium** - доступен подписчикам с тиром premium и выше  
4. **VIP** - доступен только VIP подписчикам
5. **Paid** - платный пост, требует одноразовую покупку для доступа

### Sellable посты (продажа товаров)
- **НЕ влияет на доступ к контенту поста**
- Позволяет продавать физические/цифровые товары через пост
- Может комбинироваться с любым типом доступа
- Два типа продажи: фиксированная цена и аукцион

### Поля в базе данных
```prisma
model Post {
  // Основные поля
  isLocked         Boolean   // true если пост не free
  minSubscriptionTier String? // 'basic', 'premium', 'vip'
  price           Float?     // цена для paid постов ИЛИ sellable товаров
  currency        String?    // валюта (SOL, USDC)
  
  // Sellable поля
  isSellable      Boolean
  sellType        String?    // 'FIXED_PRICE', 'AUCTION'
  quantity        Int?       // количество товара
  soldAt          DateTime?  // когда продан
  soldToId        String?    // кому продан
}
```

## Проблемы текущей архитектуры

### 1. Дублирование логики цены
- Поле `price` используется и для платного доступа к посту, и для цены товара в sellable постах
- Это создает путаницу и усложняет логику

### 2. Избыточность полей доступа
- `isLocked`, `isPremium`, `minSubscriptionTier` частично дублируют друг друга
- Нет единого источника правды для типа доступа

### 3. Смешение концепций
- Доступ к контенту и продажа товаров - разные концепции, но используют общие поля

### 4. Сложность валидации
- Много условных проверок в разных местах кода
- Легко допустить ошибку при изменении логики

## Предложения по оптимизации

### 1. Разделить цены
```prisma
model Post {
  // Доступ к контенту
  accessType      String     // 'free', 'subscribers', 'premium', 'vip', 'paid'
  accessPrice     Float?     // цена только для paid постов
  accessCurrency  String?    // валюта для доступа
  
  // Продажа товаров (независимо от доступа)
  isSellable      Boolean
  sellType        String?    // 'FIXED_PRICE', 'AUCTION'
  sellPrice       Float?     // цена товара
  sellCurrency    String?    // валюта товара
  quantity        Int?
}
```

### 2. Унифицировать типы доступа
```typescript
enum PostAccessType {
  FREE = 'free',
  BASIC_TIER = 'basic',      // для подписчиков basic+
  PREMIUM_TIER = 'premium',   // для подписчиков premium+
  VIP_TIER = 'vip',          // только для VIP
  PAID = 'paid'              // платный доступ
}
```

### 3. Создать отдельные компоненты
- `PostAccessSettings` - для настройки доступа к контенту
- `PostSellableSettings` - для настройки продажи товаров
- Разделить логику и упростить понимание

### 4. Добавить миграцию данных
```sql
-- Разделить существующие цены
UPDATE posts 
SET 
  accessPrice = price,
  accessCurrency = currency
WHERE NOT isSellable AND price IS NOT NULL;

UPDATE posts 
SET 
  sellPrice = price,
  sellCurrency = currency  
WHERE isSellable AND price IS NOT NULL;
```

### 5. Создать хелперы для проверки доступа
```typescript
// Единая функция проверки доступа
function canUserAccessPost(
  post: Post,
  user: User | null,
  userSubscription: Subscription | null
): boolean {
  // Автор всегда имеет доступ
  if (user?.id === post.creatorId) return true;
  
  // Логика по типам доступа
  switch (post.accessType) {
    case 'free':
      return true;
    case 'basic':
      return hasMinimumTier(userSubscription, 'basic');
    case 'premium':
      return hasMinimumTier(userSubscription, 'premium');
    case 'vip':
      return hasMinimumTier(userSubscription, 'vip');
    case 'paid':
      return hasPurchasedPost(user, post);
  }
}
```

### 6. Улучшить UX
- Четкое разделение в UI между доступом к контенту и продажей товаров
- Подсказки и примеры использования
- Предпросмотр того, как пост будет выглядеть для разных типов пользователей

## План внедрения

### Фаза 1: Исправление текущих багов (выполнено)
- ✅ Исправить баг с автоматической установкой isSellable
- ✅ Добавить описание для sellable чекбокса

### Фаза 2: Рефакторинг базы данных
1. Создать новую схему с разделенными полями
2. Написать миграцию для существующих данных
3. Обновить Prisma модели

### Фаза 3: Обновление API
1. Обновить эндпоинты для работы с новой схемой
2. Добавить обратную совместимость
3. Создать новые валидаторы

### Фаза 4: Обновление UI
1. Разделить компоненты настроек
2. Улучшить UX с подсказками
3. Добавить предпросмотр

### Фаза 5: Тестирование и деплой
1. Написать тесты для новой логики
2. Провести QA на staging
3. Деплой на продакшн с мониторингом

## Дополнительные улучшения

### 1. Аналитика
- Трекинг конверсии для разных типов доступа
- Статистика по продажам товаров
- A/B тестирование цен

### 2. Гибкие подписки
- Возможность создавать кастомные тиры
- Временные акции и скидки
- Бандлы постов

### 3. Улучшенные аукционы
- Автоматическое продление при ставках
- Уведомления о перебитых ставках
- История торгов

### 4. Интеграции
- Webhook'и для внешних систем
- API для управления постами
- Интеграция с системами доставки для физических товаров 