# React Error #310 WebSocket Fix Report

## üéØ –¶–µ–ª—å
–£—Å—Ç—Ä–∞–Ω–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –æ—à–∏–±–∫—É React #310, —Å–≤—è–∑–∞–Ω–Ω—É—é —Å –Ω–∞—Ä—É—à–µ–Ω–∏–µ–º –ø—Ä–∞–≤–∏–ª —Ö—É–∫–æ–≤ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π.

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã
**–ù–∞–π–¥–µ–Ω–æ**: –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª —Ö—É–∫–æ–≤ –≤ `PostsContainer` –∏ `useRealtimePosts`
- –£—Å–ª–æ–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ö—É–∫–∞ `useRealtimePosts` –≤ `PostsContainer`
- Callback —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö `useEffect` –≤ `useRealtimePosts`

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª–æ–≤–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ö—É–∫–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ PostsContainer**:
```typescript
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - —É—Å–ª–æ–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ö—É–∫–∞
const realtimeData = enableRealtime ? useRealtimePosts({
  posts: normalizedPosts,
  showNewPostsNotification,
  autoUpdateFeed,
}) : null
```

**–†–µ—à–µ–Ω–∏–µ**:
```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - —Ö—É–∫ –≤—Å–µ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è, –ª–æ–≥–∏–∫–∞ –≤–Ω—É—Ç—Ä–∏
const realtimeData = useRealtimePosts({
  posts: normalizedPosts,
  showNewPostsNotification: enableRealtime ? showNewPostsNotification : false,
  autoUpdateFeed: enableRealtime ? autoUpdateFeed : false,
})
```

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π useEffect

**–ü—Ä–æ–±–ª–µ–º–∞ –≤ useRealtimePosts**:
```typescript
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - callback —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö
useEffect(() => {
  // WebSocket –ª–æ–≥–∏–∫–∞
}, [
  user?.id, 
  handlePostLiked, 
  handlePostUnliked, 
  handlePostCreated, 
  handlePostDeleted,
  handleCommentAdded,
  handleCommentDeleted,
  handlePostPurchased,
  handleSubscriptionUpdated
])
```

**–†–µ—à–µ–Ω–∏–µ**:
```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - —Ç–æ–ª—å–∫–æ —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
useEffect(() => {
  if (!user?.id) return

  console.log('[WS] initializing socket for user:', user.id)

  // WebSocket –ª–æ–≥–∏–∫–∞
  wsService.subscribeToFeed(user.id)
  // ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞

  return () => {
    // cleanup
  }
}, [user?.id]) // –£–±–∏—Ä–∞–µ–º callback —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```

### 4. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
```typescript
console.log('[WS] initializing socket for user:', user.id)
```

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:
1. **`components/posts/layouts/PostsContainer.tsx`**
   - –£–±—Ä–∞–Ω–æ —É—Å–ª–æ–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `useRealtimePosts`
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ —É—Å–ª–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤–Ω—É—Ç—Ä–∏ —Ö—É–∫–∞

2. **`lib/hooks/useRealtimePosts.tsx`**
   - –£–±—Ä–∞–Ω—ã callback —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π useEffect
   - –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ WebSocket
   - –£–ø—Ä–æ—â–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–æ `[user?.id]`

### –ü—Ä–∏–Ω—Ü–∏–ø—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- **–í—Å–µ —Ö—É–∫–∏ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —É—Ä–æ–≤–Ω–µ** –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
- **–ù–µ—Ç —É—Å–ª–æ–≤–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è** —Ö—É–∫–æ–≤
- **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏** –≤ useEffect
- **–°—Ç–∞–±–∏–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏** –¥–ª—è callback —Ñ—É–Ω–∫—Ü–∏–π

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:
- **–û—à–∏–±–∫–∞ React #310 —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞** ‚úÖ
- **WebSocket –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ** ‚úÖ
- **–í—Å–µ —Ö—É–∫–∏ –≤—ã–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —É—Ä–æ–≤–Ω–µ** ‚úÖ
- **–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –≤ dev –∏ prod** ‚úÖ
- **–ö–æ–Ω—Å–æ–ª—å —á–∏—Å—Ç–∞—è** ‚úÖ
- **–õ–æ–≥ [WS] initializing socket –ø–æ—è–≤–ª—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑** ‚úÖ

### üöÄ –î–µ–ø–ª–æ–π:
- **–í–µ—Ä—Å–∏—è**: 20250701-164217-805e5fe
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –£—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ
- **PM2**: –û–±–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ (fonana, fonana-ws) —Ä–∞–±–æ—Ç–∞—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ
- **WebSocket**: –ü–æ—Ä—Ç 3002 –∞–∫—Ç–∏–≤–µ–Ω –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç

## üéØ –ü–∞—Ç—Ç–µ—Ä–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

### –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:
```typescript
// 1. –•—É–∫–∏ –≤—Å–µ–≥–¥–∞ –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —É—Ä–æ–≤–Ω–µ
const { user } = useUserContext()
const [isConnected, setIsConnected] = useState(false)

// 2. useEffect —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏
useEffect(() => {
  if (!user?.id) return
  
  console.log('[WS] initializing socket for user:', user.id)
  
  const socket = new WebSocket(`wss://fonana.me/ws?token=${token}`)
  
  return () => socket.close()
}, [user?.id]) // –¢–æ–ª—å–∫–æ —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```

### –ß—Ç–æ –ù–ï –¥–µ–ª–∞—Ç—å:
```typescript
// ‚ùå –£—Å–ª–æ–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ö—É–∫–æ–≤
if (token) {
  useEffect(() => { ... }) // –ù–ï –†–ê–ë–û–¢–ê–ï–¢!
}

// ‚ùå Callback —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö
useEffect(() => { ... }, [handleCallback]) // –ú–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
```

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏:
1. **–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å** - –Ω–µ—Ç –æ—à–∏–±–æ–∫ React #310
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å** - –ª–æ–≥ `[WS] initializing socket for user: ...`
3. **WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ** - —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
4. **Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** - —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### –õ–æ–≥–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ PM2 —Å—Ç–∞—Ç—É—Å–∞
ssh -p 43988 root@69.10.59.234 "pm2 status"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ WebSocket –ª–æ–≥–æ–≤
ssh -p 43988 root@69.10.59.234 "pm2 logs fonana-ws --lines 20"
```

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

React Error #310 –ø–æ–ª–Ω–æ—Å—Ç—å—é —É—Å—Ç—Ä–∞–Ω–µ–Ω. –í—Å–µ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –±–µ–∑ –Ω–∞—Ä—É—à–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª —Ö—É–∫–æ–≤. –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ –≤ production.

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–ï–®–ï–ù–û
**–í–µ—Ä—Å–∏—è**: 20250701-164217-805e5fe
**–í—Ä–µ–º—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: ~30 –º–∏–Ω—É—Ç 