# üîç M7 PHASE 1: IDENTIFY - Nginx Media API Proxy Issue

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-01-21  
**–ü—Ä–æ–±–ª–µ–º–∞:** Nginx –Ω–µ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç /api/media/ –∑–∞–ø—Ä–æ—Å—ã –∫ Next.js –Ω–∞ production  
**–°—Ç–∞—Ç—É—Å:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø - –±–ª–æ–∫–∏—Ä—É–µ—Ç Media API –¥–æ—Å—Ç—É–ø

## üìã –¢–û–ß–ù–û–ï –û–ü–ò–°–ê–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´

### üéØ **–ß—Ç–æ –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. **Production API endpoints**: `https://fonana.me/api/media/*` –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç 200 OK, –Ω–æ –ë–ï–ó –∫–∞—Å—Ç–æ–º–Ω—ã—Ö headers
2. **–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç headers**: `X-Has-Access`, `X-Should-Blur`, `X-Should-Dim`, `X-Upgrade-Prompt`
3. **Nginx –æ—Ç–¥–∞–µ—Ç —Å—Ç–∞—Ç–∏–∫—É –Ω–∞–ø—Ä—è–º—É—é**: –ó–∞–ø—Ä–æ—Å—ã –Ω–µ –¥–æ—Ö–æ–¥—è—Ç –¥–æ Next.js API

### ‚úÖ **–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. **Localhost API**: `http://localhost:3000/api/media/*` —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ —Å –≤—Å–µ–º–∏ headers
2. **–î—Ä—É–≥–∏–µ API**: `https://fonana.me/api/version` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. **PM2 –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ**: Next.js –∑–∞–ø—É—â–µ–Ω –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ :3000
4. **SSH –¥–æ—Å—Ç—É–ø**: –ù–∞—Å—Ç—Ä–æ–µ–Ω –±–µ–∑ passphrase

## üî¨ –°–û–ë–†–ê–ù–ù–´–ï –î–û–ö–ê–ó–ê–¢–ï–õ–¨–°–¢–í–ê

### **–¢–µ—Å—Ç 1: Production API (FAIL)**
```bash
curl -I https://fonana.me/api/media/posts/images/0612cc5b000dcff7ed9879dbc86942cf.JPG
HTTP/1.1 200 OK
Server: nginx/1.18.0
Content-Type: image/jpeg
# ‚ùå –ù–ï–¢ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö headers!
```

### **–¢–µ—Å—Ç 2: Localhost API (PASS)**
```bash
curl -I http://localhost:3000/api/media/posts/images/0612cc5b000dcff7ed9879dbc86942cf.JPG
HTTP/1.1 200 OK
X-Has-Access: true
X-Should-Blur: false
X-Access-Type: free
# ‚úÖ –í–°–ï headers –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç!
```

### **–¢–µ—Å—Ç 3: –î—Ä—É–≥–∏–µ API (PASS)**
```bash
curl -I https://fonana.me/api/version
HTTP/1.1 200 OK
# ‚úÖ –ü—Ä–æ–∫—Å–∏—Ä—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
```

## üîç –ö–û–ù–ö–†–ï–¢–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê

**Nginx –ù–ï –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç `/api/media/` –∫ Next.js, –∞ –æ—Ç–¥–∞–µ—Ç —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –Ω–∞–ø—Ä—è–º—É—é**

### –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
1. **Location –±–ª–æ–∫ –ø–æ—Ä—è–¥–æ–∫**: `/api/` location –¥–æ–±–∞–≤–ª–µ–Ω –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–ª–∏ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç—Å—è –¥—Ä—É–≥–∏–º–∏
2. **Regex location conflicts**: –°—Ç–∞—Ä—ã–µ regex –±–ª–æ–∫–∏ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—é—Ç .jpg/.webp —Ñ–∞–π–ª—ã
3. **Static file priorities**: Nginx static –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ API proxy

## üìä –í–õ–ò–Ø–ù–ò–ï –ù–ê –°–ò–°–¢–ï–ú–£

### üî¥ **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:**
- **–ù–µ—Ç access control**: –í—Å–µ —Ñ–∞–π–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
- **–ù–µ—Ç blur logic**: Restricted content –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –±–µ–∑ —Ä–∞–∑–º—ã—Ç–∏—è  
- **–ù–∞—Ä—É—à–µ–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –û–±—Ö–æ–¥ —Å–∏—Å—Ç–µ–º—ã –ø–æ–¥–ø–∏—Å–æ–∫ –∏ –ø–ª–∞—Ç–µ–∂–µ–π

### üéØ **–ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è —É—Å–ø–µ—Ö–∞:**
- [ ] `X-Has-Access` header –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ production
- [ ] `X-Should-Blur` —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è restricted content
- [ ] –í—Å–µ `/api/media/` –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ Next.js
- [ ] –ù–µ—Ç —Ä–µ–≥—Ä–µ—Å—Å–∏–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö API endpoints

## üö® –ë–õ–û–ö–ï–†–´

- **SSH –Ω–∞—Å—Ç—Ä–æ–µ–Ω** ‚úÖ 
- **PM2 –∑–∞–ø—É—â–µ–Ω** ‚úÖ
- **API —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ** ‚úÖ
- **–ì–æ—Ç–æ–≤ –∫ —Å–∏—Å—Ç–µ–º–Ω–æ–º—É –¥–µ–±–∞–≥—É** ‚úÖ

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** DISCOVER phase - —Å–∏—Å—Ç–µ–º–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ 