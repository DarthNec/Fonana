# üîç M7 PHASE 2: DISCOVER - –°–∏—Å—Ç–µ–º–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ Nginx

**–î–∞—Ç–∞:** 2025-01-21  
**–§–∞–∑–∞:** DISCOVER - –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∫–æ—Ä–Ω–µ–≤—ã—Ö –ø—Ä–∏—á–∏–Ω  
**–¶–µ–ª—å:** –ù–∞–π—Ç–∏ –í–°–ï –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å Nginx proxy

## üèóÔ∏è –¢–ï–ö–£–©–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

### **–ß—Ç–æ –º—ã –∑–Ω–∞–µ–º –æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ:**
1. **Next.js API**: –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ localhost:3000  
2. **Nginx**: –î–æ–ª–∂–µ–Ω –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∫ Next.js
3. **PM2**: –ó–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
4. **Location /api/**: –î–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥, –Ω–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

## üîç –°–ò–°–¢–ï–ú–ù–û–ï –ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï

### **1. –ü—Ä–æ–≤–µ—Ä–∏–º Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ**
```bash
ssh fonana-prod 'grep -n "location" /etc/nginx/sites-available/fonana'
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
7:    location /api/ {
47:    location /internal/ {
76:    location / {
```

### **2. –ê–Ω–∞–ª–∏–∑ location –±–ª–æ–∫–æ–≤ (–ö–†–ò–¢–ò–ß–ù–û)**

**Location /api/ (—Å—Ç—Ä–æ–∫–∞ 7):**
- ‚úÖ –°—É—â–µ—Å—Ç–≤—É–µ—Ç
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –ü–ï–†–ï–î location /
- ‚ùì –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ

**Location /internal/ (—Å—Ç—Ä–æ–∫–∞ 47):**
- ‚ö†Ô∏è –ú–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å regex –ø–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫–∏
- ‚ùì –ü—Ä–æ–≤–µ—Ä–∏—Ç—å regex patterns –¥–ª—è .jpg/.webp

**Location / (—Å—Ç—Ä–æ–∫–∞ 76):**
- ‚ö†Ô∏è –ú–æ–∂–µ—Ç –∏–º–µ—Ç—å try_files —Å —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ —Ñ–∞–π–ª–∞–º–∏
- ‚ùì –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã

### **3. –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**

#### **A. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ /api/ location:**
```bash
ssh fonana-prod 'sed -n "7,20p" /etc/nginx/sites-available/fonana'
```

#### **B. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å /internal/ location –Ω–∞ regex:**
```bash
ssh fonana-prod 'sed -n "47,65p" /etc/nginx/sites-available/fonana'
```

#### **C. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å location / –±–ª–æ–∫:**
```bash
ssh fonana-prod 'sed -n "76,95p" /etc/nginx/sites-available/fonana'
```

#### **D. –ù–∞–π—Ç–∏ –í–°–ï regex patterns:**
```bash
ssh fonana-prod 'grep -n "location.*~" /etc/nginx/sites-available/fonana'
```

#### **E. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å try_files –¥–∏—Ä–µ–∫—Ç–∏–≤—ã:**
```bash
ssh fonana-prod 'grep -n "try_files" /etc/nginx/sites-available/fonana'
```

## üéØ –ì–ò–ü–û–¢–ï–ó–´ –î–õ–Ø –ü–†–û–í–ï–†–ö–ò

### **–ì–∏–ø–æ—Ç–µ–∑–∞ 1: Location –ø–æ—Ä—è–¥–æ–∫ –ø—Ä–æ–±–ª–µ–º–∞**
- **–í–æ–∑–º–æ–∂–Ω–æ**: `/api/` –≤–Ω—É—Ç—Ä–∏ –¥—Ä—É–≥–æ–≥–æ –±–ª–æ–∫–∞
- **–ü—Ä–æ–≤–µ—Ä–∫–∞**: –°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏

### **–ì–∏–ø–æ—Ç–µ–∑–∞ 2: Regex location –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç**
- **–í–æ–∑–º–æ–∂–Ω–æ**: `location ~ \.(jpg|jpeg|webp)$` –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ .jpg
- **–ü—Ä–æ–≤–µ—Ä–∫–∞**: –ü–æ–∏—Å–∫ regex patterns

### **–ì–∏–ø–æ—Ç–µ–∑–∞ 3: try_files –≤ location /**
- **–í–æ–∑–º–æ–∂–Ω–æ**: `try_files $uri $uri/ =404` –æ—Ç–¥–∞–µ—Ç —Å—Ç–∞—Ç–∏–∫—É –¥–æ proxy
- **–ü—Ä–æ–≤–µ—Ä–∫–∞**: –ê–Ω–∞–ª–∏–∑ try_files –¥–∏—Ä–µ–∫—Ç–∏–≤

### **–ì–∏–ø–æ—Ç–µ–∑–∞ 4: Proxy_pass —Å–∏–Ω—Ç–∞–∫—Å–∏—Å**
- **–í–æ–∑–º–æ–∂–Ω–æ**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π proxy_pass URL
- **–ü—Ä–æ–≤–µ—Ä–∫–∞**: –°–æ–¥–µ—Ä–∂–∏–º–æ–µ location /api/

### **–ì–∏–ø–æ—Ç–µ–∑–∞ 5: Nginx cache/modules**
- **–í–æ–∑–º–æ–∂–Ω–æ**: Nginx –º–æ–¥—É–ª–∏ –∏–ª–∏ –∫—ç—à –º–µ—à–∞—é—Ç
- **–ü—Ä–æ–≤–µ—Ä–∫–∞**: nginx -V, –∞–∫—Ç–∏–≤–Ω—ã–µ –º–æ–¥—É–ª–∏

## üìä –ü–õ–ê–ù –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò

### **–≠—Ç–∞–ø 1: –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö (5 –∫–æ–º–∞–Ω–¥ –≤—ã—à–µ)**
### **–≠—Ç–∞–ø 2: –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**
### **–≠—Ç–∞–ø 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ Nginx logs**
```bash
ssh fonana-prod 'tail -f /var/log/nginx/access.log /var/log/nginx/error.log'
```

### **–≠—Ç–∞–ø 4: –¢–µ—Å—Ç —Å curl + nginx logs –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ**

## üö® –í–ê–ñ–ù–´–ï –í–û–ü–†–û–°–´ –î–õ–Ø –ò–°–°–õ–ï–î–û–í–ê–ù–ò–Ø

1. **–ï—Å—Ç—å –ª–∏ –≤–ª–æ–∂–µ–Ω–Ω—ã–µ location –±–ª–æ–∫–∏?**
2. **–ö–∞–∫–∏–µ regex patterns –∞–∫—Ç–∏–≤–Ω—ã?**
3. **–í –∫–∞–∫–æ–º –ø–æ—Ä—è–¥–∫–µ Nginx –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç locations?**
4. **–ï—Å—Ç—å –ª–∏ try_files –≤ location /?**
5. **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ª–∏ proxy_pass URL?**

---

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –í—ã–ø–æ–ª–Ω–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã –∏ —Å–æ–∑–¥–∞—Ç—å EXECUTION PLAN 