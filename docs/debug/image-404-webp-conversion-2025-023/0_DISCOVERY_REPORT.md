# üîç DISCOVERY REPORT: WebP Image 404 Errors

**–ó–∞–¥–∞—á–∞:** –ò—Å–ø—Ä–∞–≤–∏—Ç—å 404 –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ WebP –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ—Å—Ç–æ–≤  
**–î–∞—Ç–∞:** 2025-01-23  
**–ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è:** IDEAL M7  

## üìä –†–ï–ê–õ–¨–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê (–ö–û–ù–¢–ï–ö–°–¢ –ê–†–•–ò–¢–ï–ö–¢–£–†–´)

### ‚ùå –ß—Ç–æ —è –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –¥—É–º–∞–ª:
- "Next.js –Ω–µ –º–æ–∂–µ—Ç –æ—Ç–¥–∞—Ç—å static files" - –ù–ï–í–ï–†–ù–û!
- "–ù—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π API endpoint" - –ù–ï–í–ï–†–ù–û!

### ‚úÖ –ß—Ç–æ –†–ï–ê–õ–¨–ù–û –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:

#### 1. **–ú–´ –£–ñ–ï –ò–ú–ü–õ–ï–ú–ï–ù–¢–ò–†–û–í–ê–õ–ò MEDIA API –°–ò–°–¢–ï–ú–£:**
- `/api/media/[...path]/route.ts` —Å smart conditional headers strategy
- Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å X-Accel-Redirect support
- –ü–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ access control —Å monetization

#### 2. **transformMediaUrl –ö–û–ù–í–ï–†–¢–ò–†–£–ï–¢ –ü–£–¢–ò:**
```typescript
// lib/utils/mediaUrl.ts –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç:
/posts/images/file.JPG ‚Üí /posts/images/file.webp
```

#### 3. **–ù–û –ë–†–ê–£–ó–ï–† –î–ï–õ–ê–ï–¢ –ü–†–Ø–ú–´–ï STATIC REQUESTS:**
```
// –ë—Ä–∞—É–∑–µ—Ä –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç:
GET /posts/images/c6fcc7504f697b380017f94789bd0826.webp
// –≠—Ç–æ –ù–ï –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ /api/media/!
```

#### 4. **WEBP –§–ê–ô–õ–´ –ù–ï –°–û–ó–î–ê–ù–´ –ù–ê –î–ò–°–ö–ï:**
- –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ: `c6fcc7504f697b380017f94789bd0826.JPG` ‚úÖ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ: `c6fcc7504f697b380017f94789bd0826.webp` ‚ùå –ù–ï —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

## üîç ROOT CAUSE ANALYSIS

### ‚ö†Ô∏è –†–ê–ó–†–´–í –í –ê–†–•–ò–¢–ï–ö–¢–£–†–ï:

1. **Upload System**: –ó–∞–≥—Ä—É–∂–∞–µ—Ç JPG —Ñ–∞–π–ª—ã –≤ `/public/posts/images/`
2. **Database**: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—É—Ç–∏ –∫–∞–∫ JPG (`/posts/images/file.JPG`)
3. **transformMediaUrl**: –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç JPG –ø—É—Ç–∏ –≤ WebP –¥–ª—è frontend
4. **Browser**: –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç WebP —Ñ–∞–π–ª—ã –∫–∞–∫ static files
5. **File System**: –ù–ï –°–û–î–ï–†–ñ–ò–¢ WebP —Ñ–∞–π–ª—ã ‚ùå

### üéØ –ö–õ–Æ–ß–ï–í–û–ô –í–û–ü–†–û–°:
**–î–æ–ª–∂–Ω—ã –ª–∏ `/posts/images/` –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ `/api/media/` –∏–ª–∏ –∫–∞–∫ static files?**

## üìã –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –í–ê–†–ò–ê–ù–¢–´

### Option A: Static Files (—Ç–µ–∫—É—â–∏–π –ø–æ–¥—Ö–æ–¥)
- **Pros**: –ë—ã—Å—Ç—Ä–µ–µ, –∫—ç—à–∏—Ä—É–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º, –º–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- **Cons**: –ù–µ—Ç access control, –Ω–µ—Ç monetization, –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å WebP —Ñ–∞–π–ª—ã

### Option B: API Media Route (–Ω–∞—à–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Å–∏—Å—Ç–µ–º–∞)  
- **Pros**: Access control, monetization, smart headers, conversion on-the-fly
- **Cons**: –ë–æ–ª—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä, —Å–ª–æ–∂–Ω–µ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

## üîç –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï –°–ò–°–¢–ï–ú–´

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
- **–ê–≤–∞—Ç–∞—Ä—ã**: `/media/avatars/` - —Ä–∞–±–æ—Ç–∞—é—Ç —á–µ—Ä–µ–∑ API –∏–ª–∏ static
- **API endpoints**: `/api/media/[...path]` –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ–Ω
- **Nginx**: –ü—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å X-Accel-Redirect
- **Access control**: –°–∏—Å—Ç–µ–º–∞ monetization —Ä–∞–±–æ—Ç–∞–µ—Ç

### ‚ùå –ß—Ç–æ —Å–ª–æ–º–∞–Ω–æ:
- **Post images**: `/posts/images/` –∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç –∫–∞–∫ static, –Ω–æ WebP —Ñ–∞–π–ª–æ–≤ –Ω–µ—Ç
- **transformMediaUrl**: –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—É—Ç–∏

## üéØ –ì–ò–ü–û–¢–ï–ó–´ –î–õ–Ø INVESTIGATION

### –ì–∏–ø–æ—Ç–µ–∑–∞ 1: Post images –¥–æ–ª–∂–Ω—ã –∏–¥—Ç–∏ —á–µ—Ä–µ–∑ API
- –ò–∑–º–µ–Ω–∏—Ç—å `transformMediaUrl` —á—Ç–æ–±—ã –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å `/api/media/posts/images/file.JPG`
- API –±—É–¥–µ—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å JPG ‚Üí WebP on-the-fly

### –ì–∏–ø–æ—Ç–µ–∑–∞ 2: –°–æ–∑–¥–∞—Ç—å WebP —Ñ–∞–π–ª—ã –Ω–∞ –¥–∏—Å–∫–µ
- Upload system –¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞–≤–∞—Ç—å WebP versions
- –û—Å—Ç–∞–≤–∏—Ç—å static file serving

### –ì–∏–ø–æ—Ç–µ–∑–∞ 3: Nginx rewrite rule  
- Nginx –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç `/posts/images/*.webp` ‚Üí `/api/media/posts/images/*.JPG`

## üß™ PLANNED INVESTIGATION

### Phase 1: Understand Current Flow
1. –ü—Ä–æ—Å–ª–µ–¥–∏—Ç—å –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –æ—Ç upload –¥–æ browser request
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –î–û–õ–ñ–ù–û –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å vs —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
3. –ù–∞–π—Ç–∏ –≥–¥–µ –∏–º–µ–Ω–Ω–æ architecture –ºismatch

### Phase 2: Test Hypotheses  
1. Playwright MCP: —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—É—é –≥–∏–ø–æ—Ç–µ–∑—É –≤ –±—Ä–∞—É–∑–µ—Ä–µ
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å performance implications –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞
3. –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π

### Phase 3: Validate Solution
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –Ω–µ –ª–æ–º–∞–µ—Ç existing functionality
2. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ access control –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
3. –ò–∑–º–µ—Ä–∏—Ç—å impact –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

## ‚ö†Ô∏è CRITICAL REQUIREMENT

**–ù–ï –°–û–ó–î–ê–í–ê–¢–¨ –ù–û–í–´–• API ENDPOINTS** - —É –Ω–∞—Å —É–∂–µ –µ—Å—Ç—å –ø–æ–ª–Ω–∞—è media —Å–∏—Å—Ç–µ–º–∞!

–ù—É–∂–Ω–æ –ø–æ–Ω—è—Ç—å –ü–û–ß–ï–ú–£ `/posts/images/` –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ `/api/media/` –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —ç—Ç–æ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ. 