# ARCHITECTURE_CONTEXT: Post Creation 500 Error Analysis
**ID**: [post_creation_500_error_2025_017]  
**–î–∞—Ç–∞**: 17 —è–Ω–≤–∞—Ä—è 2025  
**–í—Ä–µ–º—è**: 14:25 UTC  

## üîç –û–ë–ù–ê–†–£–ñ–ï–ù–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê

### –°–∏–º–ø—Ç–æ–º—ã
- **–û—Å–Ω–æ–≤–Ω–æ–π —Å–∏–º–ø—Ç–æ–º**: POST –∑–∞–ø—Ä–æ—Å –∫ `/api/posts` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 500 Internal Server Error
- **Trigger**: –ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —á–µ—Ä–µ–∑ CreatePostModal
- **Frontend log**: "Failed to create post" –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
- **Server status**: 500 –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞

### –î–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç frontend
```json
{
  "userWallet": "5PJWbd52aontoqVh4MeDfF6XKzvwFvpYFVxtqaiZzFBD",
  "title": "",
  "content": "", 
  "type": "image",
  "category": "Art",
  "tags": [],
  "thumbnail": "/posts/images/thumb_46dfc2e43a9e77dbea23d5940f0ea380.webp",
  "mediaUrl": "/posts/images/46dfc2e43a9e77dbea23d5940f0ea380.JPG",
  "isLocked": false,
  "accessType": "free",
  "imageAspectRatio": "horizontal",  // ‚ùå –ü–†–û–ë–õ–ï–ú–ê: —Å—Ç—Ä–æ–∫–∞ –≤–º–µ—Å—Ç–æ —á–∏—Å–ª–∞
  "isSellable": false
}
```

### –°–µ—Ä–≤–µ—Ä–Ω—ã–µ –ª–æ–≥–∏ (–∏–∑ –∫–æ–Ω—Å–æ–ª–∏)
- **–û—à–∏–±–∫–∞ #1**: `Unknown field 'referrer' for include statement on model User` –≤ `/api/user/route.ts`
- **–û—à–∏–±–∫–∞ #2**: `Unknown argument 'imageAspectRatio'` –≤ `/api/posts/route.ts` (–∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ç–µ—Å—Ç–æ–≤)

## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ô –ê–ù–ê–õ–ò–ó

### –ö–æ—Ä–Ω–µ–≤—ã–µ –ø—Ä–∏—á–∏–Ω—ã

#### 1. **–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö imageAspectRatio**
- **Frontend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç**: `"horizontal"` (string)
- **Prisma —Å—Ö–µ–º–∞ –æ–∂–∏–¥–∞–µ—Ç**: DECIMAL(5,3) (number)
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: –ø–æ–ª–µ `imageAspectRatio` —Ç–∏–ø–∞ DECIMAL

#### 2. **–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–ª–µ–º referrer –≤ User –º–æ–¥–µ–ª–∏**
- **Prisma —Å—Ö–µ–º–∞**: –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è `referrerId` –∏ —Å–≤—è–∑–∏ `referrer`/`referrals`
- **Prisma client**: –ù–µ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ö–µ–º—ã
- **API –∫–æ–¥**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `include: { referrer: ... }` –∫–æ—Ç–æ—Ä–æ–µ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç—Å—è

### –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
1. **Frontend**: `CreatePostModal.tsx` - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç—Ä–æ–∫–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∞—Å–ø–µ–∫—Ç–∞
2. **Backend API**: `/api/posts/route.ts` - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç POST –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–æ–≤
3. **Backend API**: `/api/user/route.ts` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –ø–æ–ª–µ referrer
4. **Prisma Schema**: `prisma/schema.prisma` - –º–æ–¥–µ–ª—å Post —Å DECIMAL –ø–æ–ª–µ–º
5. **Database**: PostgreSQL —Ç–∞–±–ª–∏—Ü–∞ posts —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π

### –°–∏—Å—Ç–µ–º–Ω–æ–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ
- **–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å**: HIGH - –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–æ–≤ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç**: –ü–æ–ª–Ω–∞—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è –º–µ–¥–∏–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã**: –õ–æ–≥–∏ –∑–∞—Å–æ—Ä—è—é—Ç—Å—è –æ—à–∏–±–∫–∞–º–∏ referrer field

## üîß –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê

### –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- ‚úÖ **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: –ø–æ–ª—è `imageAspectRatio` –∏ `isSellable` –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ **Prisma —Å—Ö–µ–º–∞**: –ø–æ–ª—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –º–æ–¥–µ–ª–∏ Post  
- ‚ùå **Prisma client**: –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–π –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ö–µ–º—ã
- ‚ùå **Frontend –≤–∞–ª–∏–¥–∞—Ü–∏—è**: –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç—Ä–æ–∫–∏ –≤–º–µ—Å—Ç–æ —á–∏—Å–µ–ª –¥–ª—è –∞—Å–ø–µ–∫—Ç–∞

### –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –≤ –¥–∞–Ω–Ω—ã—Ö
1. **imageAspectRatio mapping**:
   - Frontend: `"horizontal"` | `"vertical"` | `"square"`
   - Backend –æ–∂–∏–¥–∞–µ—Ç: —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1.33, 0.75, 1.0)
   
2. **referrer field access**:
   - Code –æ–∂–∏–¥–∞–µ—Ç: `include: { referrer: { select: {...} } }`
   - Prisma –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç: "Unknown field referrer"

### –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- POST –∑–∞–ø—Ä–æ—Å –ø—Ä–æ—Ö–æ–¥–∏—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–æ —É—Ä–æ–≤–Ω—è Prisma
- –û—à–∏–±–∫–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –≤ –ë–î —á–µ—Ä–µ–∑ Prisma
- Prisma client –Ω–µ –º–æ–∂–µ—Ç –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

## üìã –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò –ê–ù–ê–õ–ò–ó–ê

### –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å Prisma client** - –≤–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–∞ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è
2. **–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–∞–ø–ø–∏–Ω–≥ –∞—Å–ø–µ–∫—Ç–æ–≤** - –∫–∞–∫ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫–∏ –≤ —á–∏—Å–ª–∞
3. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å referrer field usage** - –æ–±–Ω–æ–≤–∏—Ç—å API –∫–æ–¥ –∏–ª–∏ —Å—Ö–µ–º—É
4. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —á–∏—Å–ª–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏** - –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### –§–∞–π–ª—ã –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è
- `app/api/posts/route.ts` - –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–æ–≤
- `app/api/user/route.ts` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ referrer field
- `components/CreatePostModal.tsx` - —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞
- `prisma/schema.prisma` - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥–µ–ª–µ–π
- `lib/db.ts` - —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –ë–î

## üéØ –û–ñ–ò–î–ê–ï–ú–û–ï –†–ï–®–ï–ù–ò–ï

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å –º–∞–ø–ø–∏–Ω–≥ `imageAspectRatio` –≤ CreatePostModal 
2. –£–±—Ä–∞—Ç—å –∏–ª–∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å usage referrer field –≤ API
3. –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Prisma client
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
1. –°–æ–∑–¥–∞—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —É—Ä–æ–≤–Ω–µ API
2. –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—é —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ –≤ —á–∏—Å–ª–æ–≤—ã–µ
3. –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É referrer –ª–æ–≥–∏–∫–∏
4. –î–æ–±–∞–≤–∏—Ç—å comprehensive error handling –¥–ª—è Prisma –æ—à–∏–±–æ–∫

---
**–°—Ç–∞—Ç—É—Å**: –ì–æ—Ç–æ–≤ –∫ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é —Ä–µ—à–µ–Ω–∏—è  
**–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø**: SOLUTION_PLAN.md 