# SOLUTION_PLAN: Post Creation 500 Error Fix
**ID**: [post_creation_500_error_2025_017]  
**–î–∞—Ç–∞**: 17 —è–Ω–≤–∞—Ä—è 2025  
**–í—Ä–µ–º—è**: 14:30 UTC  

## üéØ –¶–ï–õ–¨ –†–ï–®–ï–ù–ò–Ø
–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–æ–≤ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ —á–µ—Ä–µ–∑ CreatePostModal, —É—Å—Ç—Ä–∞–Ω–∏–≤ 500 Internal Server Error.

## üìä –ü–õ–ê–ù –í–´–ü–û–õ–ù–ï–ù–ò–Ø

### **–§–ê–ó–ê 1: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è** (10 –º–∏–Ω—É—Ç)
**–¶–µ–ª—å**: –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Ç–æ—á–Ω—É—é –ø—Ä–∏—á–∏–Ω—É –æ—à–∏–±–∫–∏ —á–µ—Ä–µ–∑ –ª–æ–≥–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

#### –®–∞–≥ 1.1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –ª–æ–≥–æ–≤
- –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –æ—à–∏–±–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
- –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π stack trace –∏–∑ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –ª–æ–≥–æ–≤
- –ò–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Ç–æ—á–Ω—É—é —Å—Ç—Ä–æ–∫—É –≥–¥–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ—à–∏–±–∫–∞

#### –®–∞–≥ 1.2: –ê–Ω–∞–ª–∏–∑ Prisma client —Å—Ç–∞—Ç—É—Å–∞  
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ Prisma client
- –°—Ä–∞–≤–Ω–∏—Ç—å —Å—Ö–µ–º—É —Å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º client
- –í—ã—è–≤–∏—Ç—å –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π

#### –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
- ‚úÖ –ü–æ–ª–Ω—ã–π stack trace –æ—à–∏–±–∫–∏ 500
- ‚úÖ –ü–æ–Ω–∏–º–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è Prisma client
- ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å imageAspectRatio –∏ referrer

---

### **–§–ê–ó–ê 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Prisma –∏ —Å—Ö–µ–º—ã** (15 –º–∏–Ω—É—Ç)
**–¶–µ–ª—å**: –£—Å—Ç—Ä–∞–Ω–∏—Ç—å –æ—à–∏–±–∫–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ —Å—Ö–µ–º—ã

#### –®–∞–≥ 2.1: –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è Prisma client
```bash
npx prisma generate --force
```

#### –®–∞–≥ 2.2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ referrer field –≤ API
- –ù–∞–π—Ç–∏ –≤—Å–µ –º–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `include: { referrer: ... }`
- –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏–ª–∏ —É–±—Ä–∞—Ç—å if not needed
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ Prisma client –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç referrer —Å–≤—è–∑–∏

#### –®–∞–≥ 2.3: –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ö–µ–º—ã
- –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤—Å–µ –ø–æ–ª—è –≤ —Å—Ö–µ–º–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –ë–î
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –≤ Post –º–æ–¥–µ–ª–∏
- –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å referrer/referrals —Å–≤—è–∑–µ–π

#### –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π Prisma client –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ API endpoints –±–µ–∑ referrer –æ—à–∏–±–æ–∫  
- ‚úÖ –í–∞–ª–∏–¥–Ω–∞—è —Å—Ö–µ–º–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è –ë–î

---

### **–§–ê–ó–ê 3: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ imageAspectRatio mapping** (20 –º–∏–Ω—É—Ç)
**–¶–µ–ª—å**: –°–æ–∑–¥–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ –≤ —á–∏—Å–ª–æ–≤—ã–µ

#### –®–∞–≥ 3.1: –ê–Ω–∞–ª–∏–∑ CreatePostModal –ª–æ–≥–∏–∫–∏
- –ù–∞–π—Ç–∏ –≥–¥–µ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è `imageAspectRatio: "horizontal"`
- –ü–æ–Ω—è—Ç—å –ª–æ–≥–∏–∫—É –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è aspect ratio –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è: horizontal, vertical, square

#### –®–∞–≥ 3.2: –°–æ–∑–¥–∞–Ω–∏–µ transformation —Ñ—É–Ω–∫—Ü–∏–∏
–°–æ–∑–¥–∞—Ç—å mapping —Ñ—É–Ω–∫—Ü–∏—é:
```javascript
function mapAspectRatioToNumber(aspectRatio, imageFile) {
  const map = {
    'horizontal': 1.33, // 4:3 landscape
    'vertical': 0.75,   // 3:4 portrait  
    'square': 1.0       // 1:1 square
  };
  return map[aspectRatio] || 1.0;
}
```

#### –®–∞–≥ 3.3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ API
- –û–±–Ω–æ–≤–∏—Ç—å `/api/posts/route.ts` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –∞—Å–ø–µ–∫—Ç–æ–≤
- –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—é –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —á–∏—Å–ª–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏

#### –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
- ‚úÖ –§—É–Ω–∫—Ü–∏—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –∞—Å–ø–µ–∫—Ç–æ–≤
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è API –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –∏ —á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π

---

### **–§–ê–ó–ê 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è** (15 –º–∏–Ω—É—Ç)
**–¶–µ–ª—å**: –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ comprehensive —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

#### –®–∞–≥ 4.1: API —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ curl
```bash
# –¢–µ—Å—Ç —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
curl -X POST http://localhost:3000/api/posts \
  -H "Content-Type: application/json" \
  -d '{
    "userWallet": "5PJWbd52aontoqVh4MeDfF6XKzvwFvpYFVxtqaiZzFBD",
    "type": "image", 
    "category": "Art",
    "title": "Test Image Post",
    "content": "Testing image post creation",
    "imageAspectRatio": "horizontal",
    "mediaUrl": "/media/posts/test.jpg",
    "isSellable": false
  }'
```

#### –®–∞–≥ 4.2: Frontend —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Playwright
- –û—Ç–∫—Ä—ã—Ç—å CreatePostModal —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä
- –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
- –ü—Ä–æ–π—Ç–∏ –ø–æ–ª–Ω—ã–π flow —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞
- –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ

#### –®–∞–≥ 4.3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –ø–æ—Å—Ç —Å–æ–∑–¥–∞–ª—Å—è —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ imageAspectRatio —Å–æ—Ö—Ä–∞–Ω–∏–ª–æ—Å—å –∫–∞–∫ DECIMAL
- –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è

#### –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
- ‚úÖ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 201 Created –≤–º–µ—Å—Ç–æ 500 Error
- ‚úÖ Frontend —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–µ—Ç –ø–æ—Å—Ç—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
- ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

---

## ‚öôÔ∏è –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò

### –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:
1. **`app/api/posts/route.ts`** - –¥–æ–±–∞–≤–∏—Ç—å imageAspectRatio mapping
2. **`app/api/user/route.ts`** - –∏—Å–ø—Ä–∞–≤–∏—Ç—å referrer field usage  
3. **`prisma/schema.prisma`** - –µ—Å–ª–∏ –Ω—É–∂–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ —Å—Ö–µ–º—ã
4. **Prisma client** - —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è

### –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
```typescript
// –í /api/posts/route.ts
function transformAspectRatio(value: string | number): number {
  if (typeof value === 'number') return value;
  
  const aspectMap: Record<string, number> = {
    'horizontal': 1.33,
    'vertical': 0.75, 
    'square': 1.0
  };
  
  return aspectMap[value] || 1.0;
}
```

### –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö:
```typescript
// –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
function validatePostData(data: any) {
  return {
    ...data,
    imageAspectRatio: data.imageAspectRatio ? 
      transformAspectRatio(data.imageAspectRatio) : null
  };
}
```

## üîß RISK ASSESSMENT

### –ù–∏–∑–∫–∏–π —Ä–∏—Å–∫:
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã API —Å–ª–æ–µ–º
- ‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è
- ‚úÖ Frontend –æ—Å—Ç–∞–µ—Ç—Å—è unchanged

### –°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫:
- ‚ö†Ô∏è Prisma client regeneration –º–æ–∂–µ—Ç –∑–∞—Ç—Ä–æ–Ω—É—Ç—å –¥—Ä—É–≥–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- ‚ö†Ô∏è –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ API –º–æ–≥—É—Ç –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ—Å—Ç—ã

### –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫:
- üî¥ –ù–µ—Ç - –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è reversible

## üìà –ö–†–ò–¢–ï–†–ò–ò –£–°–ü–ï–•–ê

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ:
1. POST –∑–∞–ø—Ä–æ—Å –∫ `/api/posts` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 201 Created
2. CreatePostModal —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–µ—Ç –ø–æ—Å—Ç—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏  
3. –ü–æ—Å—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ feed —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ aspect ratios
4. –ù–µ—Ç 500 –æ—à–∏–±–æ–∫ –≤ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö –ª–æ–≥–∞—Ö

### –ù–µ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ:
1. API response time < 2 —Å–µ–∫—É–Ω–¥—ã
2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ memory leaks –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
3. –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –ø–æ—Å—Ç–∞–º–∏
4. –ß–∏—Å—Ç—ã–µ –ª–æ–≥–∏ –±–µ–∑ Prisma validation –æ—à–∏–±–æ–∫

## ‚è±Ô∏è –í–†–ï–ú–ï–ù–ù–ê–Ø –û–¶–ï–ù–ö–ê

- **–û–±—â–µ–µ –≤—Ä–µ–º—è**: 60 –º–∏–Ω—É—Ç
- **–§–∞–∑–∞ 1**: 10 –º–∏–Ω—É—Ç (–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞)
- **–§–∞–∑–∞ 2**: 15 –º–∏–Ω—É—Ç (Prisma –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)  
- **–§–∞–∑–∞ 3**: 20 –º–∏–Ω—É—Ç (imageAspectRatio mapping)
- **–§–∞–∑–∞ 4**: 15 –º–∏–Ω—É—Ç (—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)

## üöÄ ROLLBACK –ü–õ–ê–ù

–í —Å–ª—É—á–∞–µ –ø—Ä–æ–±–ª–µ–º:
1. –û—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ `/api/posts/route.ts`
2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–µ—Ä—Å–∏—é Prisma client: `git checkout HEAD~1 -- lib/generated/`
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å dev server
4. –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —á—Ç–æ basic API —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç

---
**–°—Ç–∞—Ç—É—Å**: –ì–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏  
**–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø**: IMPLEMENTATION_REPORT.md (–ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è) 