#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ð´Ð»Ñ Ð²Ð¸Ð´ÐµÐ¾ Ñ„Ð°Ð¹Ð»Ð¾Ð²

echo "ðŸ”§ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ð´Ð»Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸ Ð²Ð¸Ð´ÐµÐ¾..."

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½ÑƒÑŽ ÐºÐ¾Ð¿Ð¸ÑŽ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
echo "ðŸ“‹ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ð¹ ÐºÐ¾Ð¿Ð¸Ð¸..."
sudo cp /etc/nginx/sites-available/fonana /etc/nginx/sites-available/fonana.backup.$(date +%Y%m%d_%H%M%S)

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ñ Ð½Ð¾Ð²Ð¾Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÐµÐ¹
cat > /tmp/nginx-fonana-new.conf << 'EOF'
server {
    listen 80;
    server_name 69.10.59.234 fonana.me www.fonana.me;
    
    # Increase client body size for file uploads
    client_max_body_size 100M;
    
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied expired no-cache no-store private must-revalidate auth;
    gzip_types 
        text/plain 
        text/css 
        text/xml 
        text/javascript 
        application/javascript 
        application/xml+rss 
        application/json
        image/svg+xml;
    
    # Security headers
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Referrer-Policy "strict-origin-when-cross-origin";
    
    # Serve posts (images, videos, audio) directly from filesystem
    location /posts/ {
        alias /var/www/fonana/public/posts/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        
        # Enable CORS for media files
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, OPTIONS";
        
        # Specific handling for video files
        location ~ \.mp4$ {
            mp4;
            mp4_buffer_size     1m;
            mp4_max_buffer_size 5m;
        }
        
        # Ensure proper MIME types
        location ~ \.(mp4|webm|ogg)$ {
            add_header Content-Type video/mp4;
        }
    }
    
    # Serve avatars directly from filesystem
    location /avatars/ {
        alias /var/www/fonana/public/avatars/;
        expires 7d;
        add_header Cache-Control "public";
    }
    
    # Serve backgrounds directly from filesystem
    location /backgrounds/ {
        alias /var/www/fonana/public/backgrounds/;
        expires 7d;
        add_header Cache-Control "public";
    }
    
    # Static assets with long cache
    location /_next/static/ {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }
    
    # Next.js assets
    location /_next/image {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header Cache-Control "public, max-age=3600";
    }
    
    # API routes
    location /api/ {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }
    
    # Static files (images, fonts, etc.)
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp|woff|woff2|ttf|eot|css|js)$ {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        add_header Cache-Control "public, max-age=86400";
    }
    
    # Main application
    location / {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Timeout settings
        proxy_connect_timeout       60s;
        proxy_send_timeout          60s;
        proxy_read_timeout          60s;
        
        # Buffer settings
        proxy_buffering on;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
    }
    
    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
    
    # Error pages
    error_page 404 /404;
    error_page 500 502 503 504 /500;
}

# WebSocket configuration (if needed)
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}
EOF

# ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
echo "ðŸ“ ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸..."
sudo cp /tmp/nginx-fonana-new.conf /etc/nginx/sites-available/fonana

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ nginx..."
if sudo nginx -t; then
    echo "âœ… ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð²Ð°Ð»Ð¸Ð´Ð½Ð°"
    
    # ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ nginx
    echo "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° nginx..."
    sudo systemctl reload nginx
    
    echo "âœ… Nginx ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½"
else
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð² ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ nginx!"
    echo "ðŸ”™ Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð· Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ð¹ ÐºÐ¾Ð¿Ð¸Ð¸..."
    sudo cp /etc/nginx/sites-available/fonana.backup.$(date +%Y%m%d_%H%M%S) /etc/nginx/sites-available/fonana
    exit 1
fi

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ ÐµÑÐ»Ð¸ Ð¸Ñ… Ð½ÐµÑ‚
echo "ðŸ“ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹..."
sudo mkdir -p /var/www/fonana/public/posts/videos
sudo mkdir -p /var/www/fonana/public/posts/images
sudo mkdir -p /var/www/fonana/public/posts/audio
sudo mkdir -p /var/www/fonana/public/avatars
sudo mkdir -p /var/www/fonana/public/backgrounds

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
echo "ðŸ” Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°..."
sudo chown -R www-data:www-data /var/www/fonana/public/
sudo chmod -R 755 /var/www/fonana/public/posts/
sudo chmod -R 755 /var/www/fonana/public/avatars/
sudo chmod -R 755 /var/www/fonana/public/backgrounds/

echo "âœ¨ Ð“Ð¾Ñ‚Ð¾Ð²Ð¾! Nginx Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð´Ð»Ñ Ð¾Ð±ÑÐ»ÑƒÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ Ð²Ð¸Ð´ÐµÐ¾ Ñ„Ð°Ð¹Ð»Ð¾Ð²."
echo "ðŸ“¹ Ð’Ð¸Ð´ÐµÐ¾ Ñ„Ð°Ð¹Ð»Ñ‹ Ñ‚ÐµÐ¿ÐµÑ€ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ: https://fonana.me/posts/videos/"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð²Ð¸Ð´ÐµÐ¾ Ñ„Ð°Ð¹Ð»Ð¾Ð²
VIDEO_COUNT=$(find /var/www/fonana/public/posts/videos -type f -name "*.mp4" -o -name "*.webm" | wc -l)
if [ "$VIDEO_COUNT" -gt 0 ]; then
    echo "ðŸ“Š ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ Ð²Ð¸Ð´ÐµÐ¾ Ñ„Ð°Ð¹Ð»Ð¾Ð²: $VIDEO_COUNT"
else
    echo "âš ï¸  Ð’Ð¸Ð´ÐµÐ¾ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¿Ð¾ÐºÐ° Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹"
fi 