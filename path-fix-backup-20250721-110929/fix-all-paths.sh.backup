#!/bin/bash

# üîß BULK PATH FIX: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö /var/www/fonana –Ω–∞ /var/www/Fonana
# –ú7 METHODOLOGY - Comprehensive Path Audit Fix

echo "üîç –ú7 PATH AUDIT: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø—É—Ç–µ–π –≤ –ø—Ä–æ–µ–∫—Ç–µ"
echo "=================================================="

# –°–æ–∑–¥–∞–µ–º backup
BACKUP_DIR="path-fix-backup-$(date +%Y%m%d-%H%M%S)"
echo "üì¶ –°–æ–∑–¥–∞—é backup –≤ $BACKUP_DIR..."
mkdir -p "$BACKUP_DIR"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è backup —Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º
backup_and_fix() {
    local file="$1"
    echo "üîÑ –ò—Å–ø—Ä–∞–≤–ª—è—é: $file"
    
    # –°–æ–∑–¥–∞–µ–º backup
    cp "$file" "$BACKUP_DIR/$(basename $file).backup"
    
    # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—É—Ç–∏
    sed -i.tmp 's|/var/www/fonana|/var/www/Fonana|g' "$file"
    rm "$file.tmp"
}

echo ""
echo "üéØ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö .sh scripts:"
find . -name "*.sh" -not -path "./node_modules/*" -not -path "./.git/*" -not -path "./docs/*" -not -name "*backup*" | while read -r file; do
    if grep -q "/var/www/fonana" "$file"; then
        backup_and_fix "$file"
    fi
done

echo ""
echo "üéØ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö .js config files:"
find . -name "*.js" -not -path "./node_modules/*" -not -path "./.git/*" -not -path "./docs/*" -not -name "*backup*" | while read -r file; do
    if grep -q "/var/www/fonana" "$file"; then
        backup_and_fix "$file"
    fi
done

echo ""
echo "üéØ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ deployment configs:"
for file in ecosystem*.js; do
    if [[ -f "$file" && ! "$file" =~ backup ]]; then
        if grep -q "/var/www/fonana" "$file"; then
            backup_and_fix "$file"
        fi
    fi
done

echo ""
echo "üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:"
echo "========================="

# –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ø—Ä–æ–±–ª–µ–º—ã
REMAINING=$(grep -r "/var/www/fonana" . --include="*.sh" --include="*.js" --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=docs --exclude="*backup*" 2>/dev/null | wc -l)

echo "üìÅ –û—Å—Ç–∞–≤—à–∏—Ö—Å—è —Ñ–∞–π–ª–æ–≤ —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—É—Ç—è–º–∏: $REMAINING"

if [ "$REMAINING" -eq 0 ]; then
    echo "‚úÖ –í–°–ï –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–£–¢–ò –ò–°–ü–†–ê–í–õ–ï–ù–´!"
else
    echo "‚ö†Ô∏è  –û—Å—Ç–∞–ª–∏—Å—å —Ñ–∞–π–ª—ã —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—É—Ç—è–º–∏:"
    grep -r "/var/www/fonana" . --include="*.sh" --include="*.js" --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=docs --exclude="*backup*" 2>/dev/null | head -10
fi

echo ""
echo "üîß –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:"
echo "=================="
echo "1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã"
echo "2. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –Ω–∞ production"
echo "3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å PM2 –Ω–∞ production"
echo "4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å"

echo ""
echo "üì¶ Backup —Å–æ–∑–¥–∞–Ω –≤: $BACKUP_DIR"
echo "üí° –î–ª—è –æ—Ç–∫–∞—Ç–∞: cp $BACKUP_DIR/* ./"

echo ""
echo "üéâ –ú7 PATH AUDIT –ó–ê–í–ï–†–®–ï–ù!" 