# Анализ проблемы с версиями приложения и Service Worker

## Проблема
После деплоя новой версии приложения (с исправлением toFixed бага) пользователи продолжают видеть старую версию. Проблема сохраняется даже после ручной очистки кеша.

## Выявленные проблемы

### 1. Footer компонент использует динамический require()
```javascript
// components/Footer.tsx
let APP_VERSION = 'dev'
try {
  const { APP_VERSION: VERSION } = require('@/lib/version')
  APP_VERSION = VERSION
} catch {
  // В режиме разработки файл может не существовать
}
```
**Проблема**: require() может кешироваться webpack, и изменения в lib/version.ts не всегда подхватываются.

### 2. Service Worker v5 есть на сервере, но клиенты используют v4
- На сервере: `/var/www/fonana/public/sw.js` с `CACHE_NAME = 'fonana-v5'`
- В браузере: Service Worker v4 с кешем `fonana-v4`
- Service Worker кешируется с заголовком `Cache-Control: public, max-age=0`

### 3. force-refresh.js не работает корректно
```javascript
// public/force-refresh.js
var currentVersion = 'v-1751348472000';
```
**Проблемы**:
- Версия основана на timestamp, а не на git commit
- Скрипт может не выполняться из-за кеширования самого скрипта
- Не проверяет реальную версию приложения

### 4. Nginx конфигурация противоречива
```nginx
# Для HTML страниц
add_header Cache-Control "no-cache, no-store, must-revalidate" always;

# Для статических файлов (включая JS/CSS)
location ~* \.(jpg|jpeg|png|gif|ico|svg|webp|woff|woff2|ttf|eot|css|js)$ {
    # Те же no-cache заголовки
}
```
**Проблема**: Даже статические файлы с хешами не кешируются, что плохо для производительности.

### 5. Версия встраивается в бандлы при сборке
- Файл `lib/version.ts` генерируется ПОСЛЕ деплоя
- Но Footer компонент собирается ДО этого
- В результате в бандле остается старая версия

### 6. Отсутствует версионирование Service Worker
Service Worker файл не имеет версии в URL, поэтому браузеры могут кешировать старую версию до 24 часов.

## Корневые причины

1. **Неправильный порядок операций при деплое**: версия генерируется после сборки
2. **Отсутствие cache busting для Service Worker**: нет версии в URL
3. **Динамический импорт версии**: require() в Footer не пересобирается
4. **Service Worker не обновляется автоматически**: нет механизма принудительного обновления
5. **force-refresh.js не эффективен**: проверяет только timestamp

## Реальная версия vs отображаемая

- **На сервере в файле**: `20250630-224113-d26bae5` (правильная)
- **В браузере у пользователя**: `v20250630-214240-669b7fa` (старая)
- **Причина**: версия была встроена в JS бандл при предыдущей сборке 